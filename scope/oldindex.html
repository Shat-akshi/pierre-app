<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Study Analysis & Pitch Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    :root {
        /* Primary Color Palette */
        --bg-primary: #0f172a;           /* Dark Slate Blue - Main background */
        --bg-secondary: #1e293b;         /* Slightly lighter slate */
        --bg-tertiary: #334155;          /* Slate Grey - Cards, sidebars */
        --bg-quaternary: #475569;        /* Lighter slate for hover states */
        --bg-off-white: #f8fafc;         /* Off-white for filters */
        --bg-white: #ffffff;             /* Pure white for cards */
        --bg-dark-container: #1c2431;    /* New dark container color */
        
        /* Accent Colors */
        --accent-blue: #3b82f6;          /* IBM Blue - Primary actions */
        --accent-blue-hover: #2563eb;    /* Darker blue for hover */
        --accent-blue-light: #dbeafe;    /* Light blue backgrounds */
        --accent-red: #dc2626;           /* Subtle red for use cases */
        --accent-red-light: #fef2f2;     /* Light red backgrounds */
        --accent-green: #10b981;         /* Success/results color */
        --accent-green-light: #ecfdf5;   /* Light green backgrounds */
        --accent-amber: #f59e0b;         /* Warning/bookmark color */
        
        /* Text Colors */
        --text-primary: #f8fafc;         /* Primary text (light) */
        --text-secondary: #e2e8f0;       /* Secondary text */
        --text-muted: #94a3b8;           /* Muted text */
        --text-dark: #1e293b;            /* Dark text for light backgrounds */
        
        /* Glows and Effects */
        --glow-blue: rgba(59, 130, 246, 0.15);
        --glow-red: rgba(239, 68, 68, 0.15);
        --glow-green: rgba(16, 185, 129, 0.15);
    }

    html, body {
        background: var(--bg-primary) !important;
        color: var(--text-primary);
        min-height: 100vh;
    }

    #mainContent {
        background: var(--bg-primary) !important;
        min-height: 100vh;
    }

    .container {
        background: transparent;
    }
 /* Deal Sidebar Styles */
.deal-sidebar {
    position: fixed;
    top: 0;
    left: 0; /* Changed from right: 0 */
    height: 100vh;
    width: 400px;
    background: var(--bg-secondary);
    border-right: 2px solid var(--bg-tertiary); /* Changed from border-left */
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3); /* Changed shadow direction */
    transform: translateX(-100%); /* Changed from translateX(100%) */
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 120;
    overflow-y: auto;
}

.deal-sidebar.open {
    transform: translateX(0);
}

.deal-sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--bg-tertiary);
    background: var(--bg-primary);
}

.deal-sidebar-content {
    padding: 20px;
}

.deal-current-info {
    background: var(--bg-tertiary);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    border: 1px solid var(--bg-quaternary);
}

.deal-dropdown {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--bg-quaternary);
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    cursor: pointer;
    width: 100%;
    margin-bottom: 16px;
}

.deal-dropdown:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 2px var(--glow-blue);
}

.deal-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 20px;
}

.deal-btn {
    background: var(--accent-blue);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.deal-btn:hover {
    background: var(--accent-blue-hover);
    transform: translateY(-1px);
}

.deal-btn.secondary {
    background: var(--bg-quaternary);
    color: var(--text-primary);
}

.deal-btn.secondary:hover {
    background: #64748b;
}

.deal-btn.full-width {
    grid-column: 1 / -1;
}

.deal-stats {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

.deal-stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
}

.deal-stat-label {
    color: var(--text-secondary);
}

.deal-stat-value {
    color: var(--text-primary);
    font-weight: 500;
}

/* Deal Toggle Button - Move to top left and fix visibility */
.deal-toggle {
    position: fixed;
    top: 24px;
    left: 24px;
    z-index: 121;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--bg-quaternary);
    border-radius: 8px;
    width: 44px;
    height: 44px;
    display: none; /* Will be shown when workflow is selected */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.deal-toggle:hover {
    transform: scale(1.05);
    background: var(--bg-tertiary);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}

.deal-toggle.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue-hover);
    color: white;
}

/* Mini Workflow Selector - Back to top right */
.workflow-selector-mini {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 50;
    background: rgba(51, 65, 85, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(71, 85, 105, 0.3);
    border-radius: 12px;
    padding: 4px;
    box-shadow: 0 8px 32px var(--glow-blue);
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.workflow-selector-mini.hidden-by-sidebar {
    opacity: 0;
    visibility: hidden;
}

/* Navigation Mini Panel - Just dots initially */
.nav-mini-panel {
    position: fixed;
    top: 50%;
    right: 24px;
    transform: translateY(-50%);
    z-index: 50;
    background: transparent; /* No background initially */
    border: none; /* No border initially */
    border-radius: 12px;
    padding: 8px;
    display: none;
    flex-direction: column;
    gap: 8px;
    box-shadow: none; /* No shadow initially */
    transition: all 0.3s ease;
    width: 24px; /* Just enough for dots */
    overflow: visible;
}

.nav-mini-panel:hover {
    background: rgba(51, 65, 85, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(71, 85, 105, 0.3);
    box-shadow: 0 8px 32px var(--glow-blue);
    width: auto;
    min-width: 56px;
}

.nav-mini-panel.hidden-by-sidebar {
    opacity: 0;
    visibility: hidden;
}

.nav-mini-button {
    background: transparent; /* No background initially */
    color: var(--text-primary);
    border: none; /* No border initially */
    border-radius: 50%;
    width: 8px; /* Just dot size initially */
    height: 8px; /* Just dot size initially */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: visible;
}

/* Show as white dot initially */
.nav-mini-button::before {
    content: '';
    position: absolute;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
    opacity: 1;
}

/* Transform to full button on panel hover */
.nav-mini-panel:hover .nav-mini-button {
    background: var(--bg-tertiary);
    border: 1px solid var(--bg-quaternary);
    border-radius: 8px;
    width: 40px;
    height: 40px;
    padding: 0;
}

/* Hide dot, show icon on panel hover */
.nav-mini-panel:hover .nav-mini-button::before {
    opacity: 0;
    transform: scale(0);
}

/* Hide icons initially, show on panel hover */
.nav-mini-button svg {
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
    position: absolute;
}

.nav-mini-panel:hover .nav-mini-button svg {
    opacity: 1;
    transform: scale(1);
}

.nav-mini-button:hover {
    transform: scale(1.05);
}

.nav-mini-panel:hover .nav-mini-button:hover {
    background: var(--bg-quaternary);
}

.nav-mini-panel:hover .nav-mini-button.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue-hover);
    color: white;
}

/* Tooltip for dots (only when not hovered) */
.nav-mini-button::after {
    content: attr(title);
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-mini-button:hover::after {
    opacity: 1;
    visibility: visible;
}

/* Hide tooltip when panel is expanded */
.nav-mini-panel:hover .nav-mini-button::after {
    opacity: 0;
    visibility: hidden;
}
#mainContent {
    padding-top: 20px !important;
}

/* Deal Modal Updates */
.deal-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.deal-modal.active {
    opacity: 1;
    visibility: visible;
}

.deal-modal-content {
    background: var(--bg-white);
    border-radius: 12px;
    padding: 24px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    max-height: 80vh;
    overflow-y: auto;
}

.deal-modal h3 {
    color: var(--text-dark);
    margin-bottom: 16px;
}

.deal-modal label {
    color: var(--text-dark);
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.deal-modal input,
.deal-modal textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 16px;
    color: var(--text-dark);
}

.deal-modal input:focus,
.deal-modal textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px var(--glow-blue);
}

.deal-modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.deals-list-item {
    background: var(--bg-off-white);
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}

.deals-list-item h4,
.deals-list-item p {
    color: var(--text-dark) !important;
}
#makePitchBtn {
    display: none;
}
    .glass-tab {
    background: transparent;
    border: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-secondary);
    position: relative;
    z-index: 2;
}

.glass-tab.active {
    color: white;
}

.glass-tab:not(.active):hover {
    color: var(--text-primary);
}

.sliding-indicator {
    position: absolute;
    top: 0;
    height: 100%;
    background: var(--accent-blue);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    z-index: 1;
    display: block !important;
}
    
    .workflow-selector-main {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
        min-height: 100vh;
    }
    
    .workflow-selector-mini {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 50;
    background: rgba(51, 65, 85, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(71, 85, 105, 0.3);
    border-radius: 12px;
    padding: 4px;
    box-shadow: 0 8px 32px var(--glow-blue);
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.workflow-selector-mini.hidden-by-sidebar {
    opacity: 0;
    visibility: hidden;
}
    
    .expandable-section {
        transition: all 0.3s ease;
    }
    
    .expandable-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .expandable-content.expanded {
        max-height: 500px;
    }

    /* Dark container for explore page sections */
    .dark-container {
        background: var(--bg-dark-container);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .bookmark-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: 400px;
        background: var(--bg-tertiary);
        box-shadow: -4px 0 20px var(--glow-blue);
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
        overflow-y: auto;
    }
    .bookmark-indicator {
    background: #dbeafe;
    color: #1d4ed8 !important;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

#bookmarkList .text-blue-700 {
    color: #1d4ed8 !important;
}
    
    .bookmark-sidebar.open {
        transform: translateX(0);
    }

    .nav-circles {
        position: fixed;
        bottom: 100px;
        right: 24px;
        z-index: 50;
        display: none;
        flex-direction: column;
        gap: 12px;
    }
.sticky-notes-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 350px;
    background: var(--bg-tertiary);
    border-right: 2px solid var(--bg-quaternary);
    box-shadow: 4px 0 20px var(--glow-blue);
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
    overflow-y: auto;
}

.sticky-notes-sidebar.open {
    transform: translateX(0);
}

.sticky-note {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
    position: relative;
}

.sticky-note textarea {
    width: 100%;
    background: transparent;
    border: none;
    resize: none;
    font-size: 14px;
    color: #92400e;
    font-family: 'Comic Sans MS', cursive, sans-serif;
}

.sticky-note textarea:focus {
    outline: none;
}

.sticky-note .note-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.sticky-note:hover .note-actions {
    opacity: 1;
}

.delete-note {
    background: #ef4444;
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Update toggle buttons layout */
.toggle-buttons {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 50;
    display: none;
    flex-direction: column;
    gap: 12px;
}

.toggle-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--bg-quaternary);
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 20px var(--glow-blue);
}

.toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px var(--glow-blue);
    background: var(--bg-quaternary);
}

.toggle-btn.notes {
    background: var(--bg-tertiary);
    border-color: var(--bg-quaternary);
    color: var(--text-primary);
}

.toggle-btn.notes:hover {
    background: var(--bg-quaternary);
}
    .bookmark-toggle {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 50;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--bg-quaternary);
        border-radius: 50%;
        width: 56px;
        height: 56px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 20px var(--glow-blue);
    }
    
    .bookmark-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px var(--glow-blue);
        background: var(--bg-quaternary);
    }
    .toggle-btn-container {
    position: relative;
    display: inline-block;
}
.bookmark-count-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--accent-red);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    pointer-events: none;
    z-index: 10;
}
    
    .toggle-btn .bookmark-count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--accent-red);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    pointer-events: none;
}

.toggle-btn.bookmark .bookmark-count {
    display: flex;
}
    
    .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.8);
        z-index: 90;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
        background: var(--bg-white);
        color: var(--text-dark);
    }
    
    .input-field:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px var(--glow-blue);
        background: var(--bg-white);
    }
    
    .input-field::placeholder {
        color: #94a3b8;
    }

    /* Multi-select styling */
    .multi-select {
        position: relative;
    }

    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        color: var(--text-dark) !important;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .multi-select-dropdown.open {
        display: block;
    }

    .multi-select-option {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        color: var(--text-dark) !important;
    }

    .multi-select-option:hover {
        background-color: #f1f5f9;
    }

    .multi-select-option.selected {
        background-color: #dbeafe;
        color: #1d4ed8;
    }

    .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }

    .tag {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .tag-remove {
        cursor: pointer;
        font-weight: bold;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--glow-blue);
    }
    
    .btn-secondary {
        background: var(--bg-white);
        color: var(--text-dark);
        border: 1px solid #e2e8f0;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px var(--glow-blue);
    }

    .analyze-btn {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .analyze-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px var(--glow-blue);
    }

    .analyze-btn:active {
        transform: scale(0.95);
    }
    
    /* EXPLORE PAGE SPECIFIC STYLES */
    
    /* Filters Box - Off-white */
    .section-card {
        background: var(--bg-off-white);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }
    
    /* Case Studies Container - Dark Slate Blue for floating effect */
    #caseStudiesSection {
        background: var(--bg-dark-container--) !important;
        border: 2px solid var(--bg-dark-container) !important;
    }
    
    /* Case Study Cards - Pure White */
    .case-study-card-content {
        background: var(--bg-white) !important;
        border-radius: 16px;
        padding: 24px;
        height: 100%;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Use case highlight red */
    .use-case-highlight {
        background: #fef2f2 !important;
        color: #991b1b !important;
        border: 1px solid #fecaca;
        font-weight: 600;
        border-radius: 6px;
        padding: 6px 12px;
        display: inline-block;
    }

    /* Keep checkmarks green */
    .case-study-card-content .text-green-600 {
        color: #059669 !important;
    }
    /* Keep links blue */
    .case-study-card-content a {
        color: var(--accent-blue) !important;
    }
    
    /* Market Insights Box - Slate Grey */
    .industry-insights {
        background: #bcc7d6!important;
        border: 1px solid var(--bg-quaternary) !important;
    }
    
    /* Company Insights Box - Similar but different shade */
    .company-insights {
        background: #bcc7d6 !important;
        border: 1px solid #4a5568 !important;
    }

    .company-insights .input-field {
        flex: 3;
    }

    .company-insights .days-filter {
        flex: 1;
        min-width: 80px;
    }
    
    /* Inner content boxes for insights - White */
    .industry-insights .insight-content,
    .company-insights .insight-content,
    .industry-insights > div > div,
    .company-insights > div > div {
        background: var(--bg-white) !important;
        color: var(--text-dark) !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px;
        padding: 16px;
    }
    
    /* GENERATE PAGE SPECIFIC STYLES */
    
    /* Pitch Configuration Box - Off-white */
    #postsalesWorkflow .section-card:first-child {
        background: var(--bg-off-white);
    }
    
    /* Generated Pitch Box - White (remains as is) */
    #pitchSection {
        background: var(--bg-white) !important;
        border: 1px solid #e2e8f0 !important;
    }
    
    /* Case Studies Container for Generate Page - Dark Slate Blue */
    #postsalesCaseStudiesSection {
        background: var(--bg-primary) !important;
        border: 2px solid var(--bg-primary) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }

    /* Fix pitch content text colors - should be dark text on white background */
    #pitchContent,
    #pitchContent *,
    #pitchContent h1,
    #pitchContent h2,
    #pitchContent h3,
    #pitchContent h4,
    #pitchContent h5,
    #pitchContent h6,
    #pitchContent p,
    #pitchContent li,
    #pitchContent span,
    #pitchContent div,
    #pitchContent strong {
        color: var(--text-dark) !important;
    }

    #pitchSection {
        background: var(--bg-white) !important;
        border: 1px solid #e2e8f0 !important;
        color: var(--text-dark) !important;
    }

    #pitchEditor {
        color: var(--text-dark) !important;
        background: var(--bg-white) !important;
    }

    #pitchContent a {
        color: var(--accent-blue) !important;
    }

    #pitchContent a:hover {
        color: var(--accent-blue-hover) !important;
    }

    /* Email modal styles */
    .email-modal {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .email-modal .bg-white {
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .email-modal * {
        color: var(--text-dark) !important;
    }

    .email-modal input,
    .email-modal textarea {
        background: #f9fafb;
        color: var(--text-dark) !important;
    }

    .btn-primary svg {
        flex-shrink: 0;
    }
    
    /* Case Study Cards in Generate Page - Keep as is (section-card styling) */
    #postsalesCaseStudiesGrid .section-card {
        background: var(--bg-off-white);
        border: 1px solid #e2e8f0;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(248, 250, 252, 0.3);
        border-radius: 50%;
        border-top-color: var(--text-primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-up {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Strategic Summary Styles */
    .strategic-summary {
        background: var(--bg-off-white) !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .summary-section {
        background: var(--bg-white) !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px;
        padding: 16px;
    }

    .summary-icon {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
    }
    
    .bookmark-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 5;
        color: #64748b;
    }
    
    .bookmark-btn:hover {
        background: #e2e8f0;
        transform: scale(1.1);
        color: var(--text-dark);
    }
    
    .bookmark-btn.bookmarked {
        background: var(--accent-amber);
        color: white;
        border-color: var(--accent-amber);
    }

    body {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .section-card h1, 
    .section-card h2, 
    .section-card h3, 
    .section-card h4, 
    .section-card h5, 
    .section-card h6,
    .section-card label {
        color: var(--text-dark) !important;
    }

    .strategic-summary h1, 
    .strategic-summary h2, 
    .strategic-summary h3, 
    .strategic-summary h4, 
    .strategic-summary h5, 
    .strategic-summary h6,
    .strategic-summary p {
        color: var(--text-dark) !important;
    }

    .case-study-card-content h1, 
    .case-study-card-content h2, 
    .case-study-card-content h3, 
    .case-study-card-content h4, 
    .case-study-card-content h5, 
    .case-study-card-content h6,
    .case-study-card-content p,
    .case-study-card-content h5 {
    color: var(--text-dark) !important;
}
    .case-study-card-content li,
    .case-study-card-content span {
        color: var(--text-dark) !important;
    }
    
    #caseStudiesSection h2,
    #postsalesCaseStudiesSection h2 {
        color: var(--text-primary) !important;
    }
    
    #caseStudiesSection p,
    #postsalesCaseStudiesSection p {
        color: var(--text-secondary) !important;
    }

    .tag-industry {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .tag-region {
        background: #dcfce7;
        color: #166534;
    }

    .tag-size {
        background: #f3e8ff;
        color: #7c3aed;
    }
    #activeUseCasesIndicator .text-blue-700 {
    color: #1d4ed8 !important;
}

#activeUseCasesTags .bookmark-indicator {
    color: #1d4ed8 !important;
}

/* Fix postsales case study cards text */
#postsalesCaseStudiesGrid .section-card h4,
#postsalesCaseStudiesGrid .section-card h5,
#postsalesCaseStudiesGrid .section-card p,
#postsalesCaseStudiesGrid .section-card .text-sm,
#postsalesCaseStudiesGrid .section-card .font-medium {
    color: var(--text-dark) !important;
}

/* Fix any remaining white text in light backgrounds */
.section-card .text-slate-600 {
    color: var(--text-dark) !important;
}
.section-card .text-slate-700 {
    color: var(--text-dark) !important;
}
</style>
</head>
<body class="bg-slate-50 font-sans"> 
<!-- Deal Toggle Button -->
<button class="deal-toggle" id="dealToggle" onclick="toggleDealSidebar()" title="Manage Deals" style="display: none;">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
    </svg>
</button>

<!-- Deal Sidebar -->
<div class="sidebar-overlay" id="dealSidebarOverlay" onclick="toggleDealSidebar()"></div>
<div class="deal-sidebar" id="dealSidebar">
    <div class="deal-sidebar-header">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-slate-100">Deal Management</h3>
            <button onclick="toggleDealSidebar()" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="deal-sidebar-content">
        <!-- Current Deal Info -->
        <div class="deal-current-info">
            <h4 class="text-sm font-medium text-slate-200 mb-2">Current Deal</h4>
            <div id="currentDealInfo" class="text-slate-300 text-sm">
                <!-- Current deal details will be inserted here -->
            </div>
        </div>
        
        <!-- Deal Selector -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-slate-200 mb-2">Switch Deal</label>
            <select id="dealDropdown" class="deal-dropdown" onchange="switchDeal(this.value)">
                <!-- Deals will be populated here -->
            </select>
        </div>
        
        <!-- Deal Actions -->
        <div class="deal-actions">
            <button class="deal-btn" onclick="showNewDealModal()">+ New Deal</button>
            <button class="deal-btn secondary" onclick="showManageDealsModal()">Manage</button>
            <button class="deal-btn secondary" onclick="exportDeal()">Export</button>
            <button class="deal-btn secondary" onclick="importDeal()">Import</button>
        </div>
        
        <!-- Deal Stats -->
        <div class="deal-stats">
            <h4 class="text-sm font-medium text-slate-200 mb-3">Current Deal Stats</h4>
            <div class="deal-stat-item">
                <span class="deal-stat-label">Bookmarks:</span>
                <span class="deal-stat-value" id="dealBookmarkCount">0</span>
            </div>
            <div class="deal-stat-item">
                <span class="deal-stat-label">Notes:</span>
                <span class="deal-stat-value" id="dealNotesCount">0</span>
            </div>
            <div class="deal-stat-item">
                <span class="deal-stat-label">Pitch Generated:</span>
                <span class="deal-stat-value" id="dealPitchStatus">No</span>
            </div>
            <div class="deal-stat-item">
                <span class="deal-stat-label">Last Modified:</span>
                <span class="deal-stat-value" id="dealLastModified">--</span>
            </div>
        </div>
    </div>
</div>
    <!-- Main Workflow Selector -->
    <div id="workflowSelectorMain" class="workflow-selector-main flex items-center justify-center">
        <div class="text-center max-w-4xl mx-auto px-6">
            <h1 class="text-5xl font-light text-slate-100 mb-4">Case Study Platform</h1>
            <p class="text-xl text-slate-300 mb-12">Explore insights and generate compelling pitches</p>
            
            <div class="grid md:grid-cols-2 gap-8 max-w-2xl mx-auto">
                <div class="group cursor-pointer" onclick="selectWorkflow('presales')">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 hover:bg-white/20 transition-all duration-300 hover:scale-105">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-medium text-white mb-4">Explore Scope</h3>
                        <p class="text-white/70">Search and discover use cases, market trends, comapny trends</p>
                    </div>
                </div>
                
                <div class="group cursor-pointer" onclick="selectWorkflow('postsales')">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 hover:bg-white/20 transition-all duration-300 hover:scale-105">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-medium text-white mb-4">Follow-Up</h3>
                        <p class="text-white/70">Create personalised pitches with AI assistance backed by metrics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Mini Workflow Selector -->
<div id="workflowSelectorMini" class="workflow-selector-mini hidden">
    <div class="flex relative bg-slate-700 rounded-lg p-1">
        <button id="presalesTabMini" class="glass-tab px-4 py-2 text-sm font-medium rounded-lg transition-all" onclick="switchWorkflow('presales')">
            Explore
        </button>
        <button id="postsalesTabMini" class="glass-tab px-4 py-2 text-sm font-medium rounded-lg transition-all" onclick="switchWorkflow('postsales')">
            Follow-Up
        </button>
        <div id="slidingIndicator" class="sliding-indicator"></div>
    </div>
</div>

<!-- Navigation Mini Panel -->
<div class="nav-mini-panel" id="navMiniPanel">
    <!-- Will be populated by JavaScript based on current workflow -->
</div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden min-h-screen pt-20 pb-8">
        <div style="height: 80px;"></div> 
        <div class="container mx-auto px-6 max-w-6xl">
            
            <!-- Presales Workflow -->
            <div id="presalesWorkflow" class="hidden">
              <!-- Search Section -->
<div class="section-card mb-8">
    <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-3">Filters</label>
        
        <!-- Company Name Filter - Top Row -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">
                Company Name <span class="text-red-500">*</span>
            </label>
            <input type="text" id="presalesCompany" class="input-field" placeholder="Company name...">
        </div>
        
        <!-- Other Filters - Grid Layout -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    Industry <span class="text-red-500">*</span>
                </label>
                <select id="presalesIndustry" class="input-field">
                    <option value="">Select industry...</option>
                    <option value="Technology Industry">Technology Industry</option>
                    <option value="Manufacturing">Manufacturing</option>
                    <option value="Financial services">Financial services</option>
                    <option value="Professional services">Professional services</option>
                    <option value="Retail">Retail</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Energy and utilities">Energy and utilities</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Media and entertainment">Media and entertainment</option>
                    <option value="Public sector and NGOs">Public sector and NGOs</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Region</label>
                <select id="presalesRegion" class="input-field">
                    <option value="World">World (Default)</option>
                    <option value="Asia">Asia</option>
                    <option value="Americas">Americas</option>
                    <option value="Europe">Europe</option>
                    <option value="Oceania">Oceania</option>
                    <option value="Africa">Africa</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    Product <span class="text-red-500">*</span>
                </label>
                <div class="multi-select">
                    <div id="presalesProduct" class="input-field cursor-pointer" onclick="toggleMultiSelect('presalesProductDropdown')">
                        <span id="presalesProductDisplay">Select products...</span>
                        <svg class="w-4 h-4 float-right mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div id="presalesProductDropdown" class="multi-select-dropdown">
                        <div class="multi-select-option" data-value="AI and ML">AI and ML</div>
                        <div class="multi-select-option" data-value="Compute and servers">Compute and servers</div>
                        <div class="multi-select-option" data-value="Analytics">Analytics</div>
                        <div class="multi-select-option" data-value="IT automation">IT automation</div>
                        <div class="multi-select-option" data-value="Middleware">Middleware</div>
                        <div class="multi-select-option" data-value="Business automation">Business automation</div>
                        <div class="multi-select-option" data-value="Databases">Databases</div>
                        <div class="multi-select-option" data-value="Asset management">Asset management</div>
                        <div class="multi-select-option" data-value="Security">Security</div>
                        <div class="multi-select-option" data-value="Storage">Storage</div>
                    </div>
                    <div id="presalesProductTags" class="selected-tags"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-3">What are you looking for? (Optional)</label>
        <textarea id="presalesPrompt" rows="3" class="input-field resize-none" placeholder="Describe what you're looking for... e.g., 'retail companies that improved customer experience using AI'"></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center gap-4 mt-6">
        <button onclick="exploreCaseStudies()" class="btn-primary" id="exploreBtn">
            <span id="exploreBtnText">Explore Scope</span>
        </button>
    </div>
</div>
                <!-- Strategic Summary Section -->
                <div id="strategicSummarySection" class="strategic-summary section-card mb-8 hidden">
                    <div class="flex items-center mb-6">
                        <div class="summary-icon w-12 h-12 rounded-full flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-light text-slate-900 mb-1">Strategic Pitch Summary</h2>
                            <p class="text-slate-600">Key insights and trends for your pitch strategy</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Top Use Cases -->
                        <div class="summary-section">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-slate-900">Top Use Cases to Pitch</h3>
                            </div>
                            <div id="topUseCases" class="space-y-2">
                                <!-- Use cases will be inserted here -->
                            </div>
                        </div>

                        <!-- Company Trends -->
                        <div class="summary-section">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-slate-900">Company Trends</h3>
                            </div>
                            <div id="companyTrends" class="space-y-2">
                                <!-- Company trends will be inserted here -->
                            </div>
                        </div>

                        <!-- Industry Trends -->
                        <div class="summary-section">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-semibold text-slate-900">Industry Trends</h3>
                            </div>
                            <div id="industryTrends" class="space-y-2">
                                <!-- Industry trends will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-white/50 rounded-lg border border-sky-200">
                        <div class="flex items-center text-sm text-sky-700">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="summaryStats">Analysis based on case studies and market data</span>
                        </div>
                    </div>
                </div>

                <!-- Dark container encapsulating case studies and insights -->
                <div class="dark-container hidden" id="exploreResultsContainer">
                    <!-- Case Studies Grid -->
                    <div id="caseStudiesSection" class="mb-8">
                        <div class="mb-6">
                            <h2 class="text-2xl font-light text-slate-100 mb-2">Case Studies</h2>
                            <p class="text-slate-300" id="caseStudiesCount">0 results found</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="caseStudiesGrid">
                            <!-- Case study cards will be inserted here -->
                        </div>
                    </div>

                   <!-- Market Insights -->
<div id="marketInsightsSection" class="grid lg:grid-cols-2 gap-6">
    <!-- Market Trends -->
    <div class="section-card industry-insights">
        <div class="mb-6">
            <h3 class="text-xl font-medium text-slate-900 mb-4">Market Insights</h3>
        </div>
        <div id="trendsContent" class="space-y-4">
            <!-- Market trends content -->
        </div>
        <div id="trendsLoading" class="hidden text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-slate-600">Analysing market trends...</p>
        </div>
    </div>

    <!-- Company Intelligence -->
    <div class="section-card company-insights">
        <div class="mb-6">
            <h3 class="text-xl font-medium text-slate-900 mb-4">Company Intelligence</h3>
        </div>
        <div id="companyContent" class="space-y-4">
            <!-- Company intelligence content -->
        </div>
        <div id="companyLoading" class="hidden text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-slate-600">Gathering intelligence...</p>
        </div>
    </div>
</div>

<!-- Make Pitch Button -->
<div class="text-center mt-8">
    <button onclick="makePitchFromExplore()" class="btn-primary text-lg px-8 py-3" id="makePitchBtn">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Make Pitch
    </button>
</div>
                </div>
            </div>

            <!-- Postsales Workflow -->
            <div id="postsalesWorkflow" class="hidden">
                <!-- Generated Pitch (moved to top) -->
                <div id="pitchSection" class="section-card mb-8 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-light text-slate-900">Generated Pitch</h2>
                        <div class="flex gap-2">
                            <button onclick="sendPitchByEmail()" class="btn-primary text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Send Mail
                            </button>
                            <button onclick="editPitch()" class="btn-secondary text-sm">Edit</button>
                            <button onclick="copyPitch()" class="btn-secondary text-sm">Copy</button>
                            <button onclick="downloadPitch()" class="btn-secondary text-sm">Download</button>
                        </div>
                    </div>
                    <div id="pitchContent" class="prose max-w-none bg-slate-50 p-6 rounded-lg">
                        <!-- Pitch content will be inserted here -->
                    </div>
                </div>

                <!-- Simplified Pitch Configuration -->
                <div class="section-card mb-8">
                    <h2 class="text-2xl font-light text-slate-900 mb-6">Pitch Configuration</h2>
                    
                    <!-- Main configuration row -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
    <label class="block text-sm font-medium text-slate-700 mb-2">Use Case</label>
    <select id="postsalesUseCase" class="input-field">
        <option value="">All use cases</option>
        <option value="Digital Transformation">Digital Transformation</option>
        <option value="Cloud">Cloud</option>
        <option value="Cybersecurity">Cybersecurity</option>
        <option value="Analytics">Analytics</option>
        <option value="Business operations">Business operations</option>
        <option value="Consulting">Consulting</option>
        <option value="IT Automation">IT Automation</option>
        <option value="Business automation">Business automation</option>
        <option value="IT infrastructure">IT infrastructure</option>
    </select>
    <!-- NEW: Active use cases indicator -->
    <div id="activeUseCasesIndicator" class="mt-2 hidden">
        <div class="text-xs text-blue-700 mb-1">Active use cases from bookmarks:</div>
        <div id="activeUseCasesTags" class="flex flex-wrap gap-1">
            <!-- Use case tags will be inserted here -->
        </div>
    </div>
</div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Additional Context</label>
                            <textarea id="additionalContext" rows="1" class="input-field resize-none" placeholder="Any specific requirements or context for the pitch..."></textarea>
                        </div>
                    </div>

                    <!-- Expandable Case Study Filters -->
                    <div class="expandable-section">
                        <button onclick="toggleFilters('postsalesFilters')" class="flex items-center text-sm text-slate-600 hover:text-slate-900 mb-4">
                            <span>Show case study filters</span>
                            <svg class="w-4 h-4 ml-1 transition-transform" id="postsalesFiltersIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="postsalesFilters" class="expandable-content">
                            <div class="grid md:grid-cols-2 lg:grid-cols-2 gap-4 pt-4 border-t border-slate-200">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Pitch Type</label>
                                    <select id="pitchType" class="input-field">
                                        <option value="email">Email</option>
                                        <option value="presentation">Presentation</option>
                                        <option value="executive_summary">Executive Summary</option>
                                        <option value="cold_outreach">Cold Outreach</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Target Company</label>
                                    <input type="text" id="targetCompany" class="input-field" placeholder="Company name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Industry</label>
                                    <select id="postsalesIndustry" class="input-field">
                                        <option value="">All industries</option>
                                        <option value="Technology Industry">Technology Industry</option>
                                        <option value="Manufacturing">Manufacturing</option>
                                        <option value="Financial services">Financial services</option>
                                        <option value="Professional services">Professional services</option>
                                        <option value="Retail">Retail</option>
                                        <option value="Transportation">Transportation</option>
                                        <option value="Energy and utilities">Energy and utilities</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Media and entertainment">Media and entertainment</option>
                                        <option value="Public sector and NGOs">Public sector and NGOs</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Region</label>
                                    <select id="postsalesRegion" class="input-field">
                                        <option value="">All regions</option>
                                        <option value="Asia">Asia</option>
                                        <option value="Americas">Americas</option>
                                        <option value="Europe">Europe</option>
                                        <option value="World">World</option>
                                        <option value="Oceania">Oceania</option>
                                        <option value="Africa">Africa</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Product</label>
                                    <select id="postsalesProduct" class="input-field">
                                        <option value="">All products</option>
                                        <option value="AI and ML">AI and ML</option>
                                        <option value="Compute and servers">Compute and servers</option>
                                        <option value="Analytics">Analytics</option>
                                        <option value="IT automation">IT automation</option>
                                        <option value="Middleware">Middleware</option>
                                        <option value="Business automation">Business automation</option>
                                        <option value="Databases">Databases</option>
                                        <option value="Asset management">Asset management</option>
                                        <option value="Security">Security</option>
                                        <option value="Storage">Storage</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Natural Language Search (Optional)</label>
                                    <textarea id="postsalesPrompt" rows="2" class="input-field resize-none" placeholder="Describe what you're looking for..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button onclick="generatePitch()" class="btn-primary" id="generateBtn">
                            <span id="generateBtnText">Regenerate Pitch</span>
                        </button>
                    </div>
                </div>

                <!-- Case Studies for Postsales -->
                <div id="postsalesCaseStudiesSection" class="section-card hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-light text-slate-900 mb-2">Similar Case Studies</h2>
                        <p class="text-slate-600" id="postsalesCaseStudiesCount">0 results found</p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6" id="postsalesCaseStudiesGrid">
                        <!-- Case studies will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Mini Panel -->
<div class="nav-mini-panel" id="navMiniPanel">
    <!-- Will be populated by JavaScript based on current workflow -->
</div>

<!-- Toggle Buttons -->
<div class="toggle-buttons" id="toggleButtons">
    <!-- Sticky Notes Toggle -->
    <button class="toggle-btn notes" onclick="toggleStickyNotes()" title="Sticky Notes">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v9a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg>
    </button>
    
    <!-- Bookmark Toggle with its own specific count -->
    <div class="toggle-btn-container">
        <button class="toggle-btn bookmark" onclick="toggleBookmarkSidebar()" title="Bookmarks">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
            </svg>
        </button>
        <div id="bookmarkCount" class="bookmark-count-badge hidden">0</div>
    </div>
</div>

<!-- Sticky Notes Sidebar -->
<div class="sidebar-overlay" id="stickyNotesOverlay" onclick="toggleStickyNotes()"></div>
<div class="sticky-notes-sidebar" id="stickyNotesSidebar">
    <div class="p-6 border-b border-slate-200">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-medium text-slate-900">Sticky Notes</h3>
            <button onclick="toggleStickyNotes()" class="text-slate-500 hover:text-slate-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="flex gap-2">
            <button onclick="addStickyNote()" class="btn-primary text-sm">Add Note</button>
            <button onclick="clearAllNotes()" class="btn-secondary text-sm text-red-600">Clear All</button>
        </div>
    </div>
    <div id="stickyNotesList" class="p-6 space-y-4">
        <!-- Sticky notes will be inserted here -->
    </div>
</div>

    <!-- Bookmark Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleBookmarkSidebar()"></div>
    <div class="bookmark-sidebar" id="bookmarkSidebar">
        <div class="p-6 border-b border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium text-slate-900">Reference Case Studies</h3>
                <button onclick="toggleBookmarkSidebar()" class="text-slate-500 hover:text-slate-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="exportBookmarks()" class="btn-secondary text-sm">Export</button>
                <button onclick="clearAllBookmarks()" class="btn-secondary text-sm text-red-600">Clear All</button>
            </div>
        </div>
        <div id="bookmarkList" class="p-6 space-y-4">
            <!-- Bookmarked case studies will be inserted here -->
        </div>
    </div>

    <script>
        // Global variables
        let currentWorkflow = null;
        let globalCaseStudies = [];
        let bookmarkedCaseStudies = JSON.parse(localStorage.getItem('bookmarkedCaseStudies')) || [];
        let originalPitchContent = '';
        let currentFilters = {};
        let hasMarketInsights = false;
        let hasCompanyInsights = false;
        let selectedProducts = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log(' DOM loaded, initializing systems...');
    
    // Initialize basic UI first
    updateBookmarkCount();
    updateReferenceDropdown();
    updateUseCaseDisplay();
    displayStickyNotes();
    
    // Initialize deals system with a slight delay to ensure DOM is ready
    setTimeout(() => {
        initializeDealsBasic();
    }, 200);
    
    // Setup auto-save
    setupAutoSave();
    
    console.log(' All systems initialized');
});
// Deal sidebar toggle
// Deal Management Variables - CORRECTED
let currentDealId = null;
let currentDealName = null;
let deals = JSON.parse(localStorage.getItem('deals')) || {};
let dealIdCounter = parseInt(localStorage.getItem('dealIdCounter')) || 1;

function initializeDealsBasic() {
    // Load deals from localStorage or create empty object
    deals = JSON.parse(localStorage.getItem('deals')) || {};
    dealIdCounter = parseInt(localStorage.getItem('dealIdCounter')) || 1;
    
    console.log(' Loaded deals:', Object.keys(deals).length, 'deals found');
    console.log(' Deals object:', deals);
    
    // If no deals exist, create a default one
    if (Object.keys(deals).length === 0) {
        createDefaultDeal();
    } else {
        // Load the last active deal ID
        const lastDealId = localStorage.getItem('currentDealId');
        console.log(' Looking for last active deal:', lastDealId);
        
        if (lastDealId && deals[lastDealId]) {
            currentDealId = lastDealId;
            currentDealName = deals[lastDealId].name;
            console.log(' Restored last active deal:', currentDealName);
            
            // Load the deal data immediately
            loadCurrentDealData();
        } else {
            // Set to first available deal
            const firstDealId = Object.keys(deals)[0];
            currentDealId = firstDealId;
            currentDealName = deals[firstDealId].name;
            localStorage.setItem('currentDealId', currentDealId);
            console.log(' Set to first available deal:', currentDealName);
            
            // Load the deal data immediately
            loadCurrentDealData();
        }
    }
    
    // Update UI elements - Use setTimeout to ensure DOM is ready
    setTimeout(() => {
        updateDealDropdown();
        updateCurrentDealInfo();
        updateDealStats();
        console.log(' UI elements updated');
    }, 100);
    
    console.log(' Deals system initialized with current deal:', currentDealName);
}

function createDefaultDeal() {
    const defaultDeal = {
        id: dealIdCounter++,
        name: 'Default Deal',
        client: '',
        description: 'Auto-created deal',
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        currentWorkflow: null, // Don't auto-load workflow
        presalesFilters: {
            industry: '',
            company: '',
            region: '',
            products: [],
            prompt: ''
        },
        postsalesFilters: {
            industry: '',
            region: '',
            useCase: '',
            product: '',
            prompt: '',
            pitchType: 'email',
            targetCompany: '',
            additionalContext: ''
        },
        globalCaseStudies: [],
        bookmarkedCaseStudies: [],
        stickyNotes: [],
        generatedPitch: '',
        marketInsights: null,
        companyInsights: null
    };
    
    deals[defaultDeal.id] = defaultDeal;
    currentDealId = defaultDeal.id;
    currentDealName = defaultDeal.name;
    
    localStorage.setItem('deals', JSON.stringify(deals));
    localStorage.setItem('dealIdCounter', dealIdCounter.toString());
    localStorage.setItem('currentDealId', currentDealId);
    
    // Don't auto-load workflow - stay on start page
    console.log(' Default deal created:', defaultDeal.name);
}

function createEmptyDealData() {
    return {
        id: null,
        name: '',
        client: '',
        description: '',
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        currentWorkflow: null,
        presalesFilters: {
            industry: '',
            company: '',
            region: '',
            products: [],
            prompt: ''
        },
        postsalesFilters: {
            industry: '',
            region: '',
            useCase: '',
            product: '',
            prompt: '',
            pitchType: 'email',
            targetCompany: '',
            additionalContext: ''
        },
        globalCaseStudies: [],
        bookmarkedCaseStudies: [],
        stickyNotes: [],
        generatedPitch: '',
        marketInsights: null,
        companyInsights: null
    };
}
function toggleDealSidebar() {
    const sidebar = document.getElementById('dealSidebar');
    const overlay = document.getElementById('dealSidebarOverlay');
    const toggle = document.getElementById('dealToggle');
    const workflowSelector = document.getElementById('workflowSelectorMini');
    
    const isOpen = sidebar.classList.contains('open');
    
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        toggle.classList.remove('active');
        workflowSelector.classList.remove('hidden-by-sidebar');
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        toggle.classList.add('active');
        workflowSelector.classList.add('hidden-by-sidebar');
        
        // Ensure dropdown is populated when sidebar opens
        updateDealDropdown();
        updateCurrentDealInfo();
        updateDealStats();
    }
}

function updateCurrentDealInfo() {
    const infoEl = document.getElementById('currentDealInfo');
    if (!infoEl) return;
    
    if (!currentDealId || !deals[currentDealId]) {
        infoEl.innerHTML = '<div class="text-slate-400">No deal selected</div>';
        return;
    }
    
    const deal = deals[currentDealId];
    infoEl.innerHTML = `
        <div class="font-medium">${deal.name}</div>
        <div class="text-xs mt-1">${deal.client || 'No client specified'}</div>
        <div class="text-xs mt-1 text-slate-400">${deal.description || 'No description'}</div>
    `;
}

function updateDealStats() {
    if (!currentDealId || !deals[currentDealId]) return;
    
    const deal = deals[currentDealId];
    
    const bookmarkCountEl = document.getElementById('dealBookmarkCount');
    const notesCountEl = document.getElementById('dealNotesCount');
    const pitchStatusEl = document.getElementById('dealPitchStatus');
    const lastModifiedEl = document.getElementById('dealLastModified');
    
    if (bookmarkCountEl) bookmarkCountEl.textContent = deal.bookmarkedCaseStudies?.length || 0;
    if (notesCountEl) notesCountEl.textContent = deal.stickyNotes?.length || 0;
    if (pitchStatusEl) pitchStatusEl.textContent = deal.generatedPitch ? 'Yes' : 'No';
    if (lastModifiedEl) lastModifiedEl.textContent = new Date(deal.lastModified).toLocaleDateString();
}

// Update existing functions
function updateDealDropdown() {
    const dropdown = document.getElementById('dealDropdown');
    if (!dropdown) {
        console.log(' Deal dropdown not found');
        return;
    }
    
    // Clear existing options and event listeners
    dropdown.innerHTML = '';
    dropdown.onchange = null;
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select a deal...';
    dropdown.appendChild(defaultOption);
    
    console.log(' Updating dropdown with deals:', Object.keys(deals));
    
    // Add all deals to dropdown
    Object.values(deals).forEach(deal => {
        const option = document.createElement('option');
        option.value = String(deal.id); // Ensure it's a string
        option.textContent = deal.name;
        
        // Mark current deal as selected
        if (String(deal.id) === String(currentDealId)) {
            option.selected = true;
            console.log(' Selected deal in dropdown:', deal.name);
        }
        
        dropdown.appendChild(option);
    });
    
    // Re-bind the onchange event
    dropdown.onchange = function() {
        const selectedDealId = this.value;
        if (selectedDealId) {
            switchDeal(selectedDealId);
        }
    };
    
    console.log(' Deal dropdown updated with', Object.keys(deals).length, 'deals');
}

function switchDeal(dealId) {
    if (!dealId || dealId === '' || String(dealId) === String(currentDealId)) {
        console.log(' Invalid deal switch:', dealId);
        return;
    }
    
    console.log(' Switching from deal', currentDealId, 'to deal', dealId);
    
    // Save current deal data before switching
    if (currentDealId) {
        saveCurrentDealData();
    }
    
    // Switch to new deal
    currentDealId = dealId;
    currentDealName = deals[dealId].name;
    localStorage.setItem('currentDealId', currentDealId);
    
    // Load new deal data
    loadCurrentDealData();
    
    // Reset UI state
    resetUIState();
    
    // Update sidebar info
    updateCurrentDealInfo();
    updateDealStats();
    
    console.log(' Switched to deal:', currentDealName);
}

// Update manage deals modal content
function updateDealsList() {
    const list = document.getElementById('dealsList');
    list.innerHTML = '';
    
    Object.values(deals).forEach(deal => {
        const dealItem = document.createElement('div');
        dealItem.className = 'deals-list-item';
        dealItem.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-medium text-slate-900">${deal.name}</h4>
                    <p class="text-sm text-slate-600 mt-1">${deal.client || 'No client specified'}</p>
                    <p class="text-xs text-slate-500 mt-2">Created: ${new Date(deal.createdAt).toLocaleDateString()}</p>
                    <p class="text-xs text-slate-500">Modified: ${new Date(deal.lastModified).toLocaleDateString()}</p>
                    <div class="flex gap-4 mt-2 text-xs text-slate-500">
                        <span> ${deal.bookmarkedCaseStudies?.length || 0} bookmarks</span>
                        <span> ${deal.stickyNotes?.length || 0} notes</span>
                        <span> ${deal.generatedPitch ? 'Has pitch' : 'No pitch'}</span>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="duplicateDeal(${deal.id})" class="deal-btn secondary text-xs px-2 py-1">Duplicate</button>
                    ${Object.keys(deals).length > 1 ? `<button onclick="deleteDeal(${deal.id})" class="deal-btn text-xs px-2 py-1" style="background: #ef4444;">Delete</button>` : ''}
                </div>
            </div>
        `;
        list.appendChild(dealItem);
    });
}

// Add import functionality
function importDeal() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                
                // Create new deal from imported data
                const newDeal = createEmptyDealData();
                newDeal.id = dealIdCounter++;
                newDeal.name = importData.dealInfo?.name + ' (Imported)' || 'Imported Deal';
                newDeal.client = importData.dealInfo?.client || '';
                newDeal.description = importData.dealInfo?.description || '';
                newDeal.bookmarkedCaseStudies = importData.bookmarkedCaseStudies || [];
                newDeal.generatedPitch = importData.generatedPitch || '';
                newDeal.stickyNotes = importData.stickyNotes || [];
                newDeal.presalesFilters = importData.filters?.presales || newDeal.presalesFilters;
                newDeal.postsalesFilters = importData.filters?.postsales || newDeal.postsalesFilters;
                
                deals[newDeal.id] = newDeal;
                localStorage.setItem('deals', JSON.stringify(deals));
                localStorage.setItem('dealIdCounter', dealIdCounter.toString());
                
                updateDealDropdown();
                updateDealsList();
                alert('Deal imported successfully!');
            } catch (error) {
                alert('Error importing deal. Please check the file format.');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function saveCurrentDealData() {
    if (!currentDealId || !deals[currentDealId]) {
        console.log(' No current deal to save');
        return;
    }
    
    const currentDeal = deals[currentDealId];
    
    // Save current state including background process results
    currentDeal.lastModified = new Date().toISOString();
    currentDeal.currentWorkflow = currentWorkflow;
    
    // Save presales data
    if (document.getElementById('presalesIndustry')) {
        currentDeal.presalesFilters = {
            industry: document.getElementById('presalesIndustry').value,
            company: document.getElementById('presalesCompany').value,
            region: document.getElementById('presalesRegion').value,
            products: selectedProducts || [],
            prompt: document.getElementById('presalesPrompt').value
        };
    }
    
    // Save postsales data
    if (document.getElementById('postsalesIndustry')) {
        currentDeal.postsalesFilters = {
            industry: document.getElementById('postsalesIndustry').value,
            region: document.getElementById('postsalesRegion').value,
            useCase: document.getElementById('postsalesUseCase').value,
            product: document.getElementById('postsalesProduct').value,
            prompt: document.getElementById('postsalesPrompt').value,
            pitchType: document.getElementById('pitchType').value,
            targetCompany: document.getElementById('targetCompany').value,
            additionalContext: document.getElementById('additionalContext').value
        };
    }
    
    // Save global data including background insights
    currentDeal.globalCaseStudies = globalCaseStudies || [];
    currentDeal.generatedPitch = originalPitchContent || '';
    currentDeal.bookmarkedCaseStudies = bookmarkedCaseStudies || [];
    currentDeal.stickyNotes = stickyNotes || [];
    currentDeal.marketInsights = storedMarketInsights;
    currentDeal.companyInsights = storedCompanyInsights;
    
    // Save to localStorage
    deals[currentDealId] = currentDeal;
    localStorage.setItem('deals', JSON.stringify(deals));
    
    console.log(' Deal data saved including background insights for:', currentDeal.name);
}

function loadCurrentDealData() {
    if (!currentDealId || !deals[currentDealId]) {
        console.log(' No current deal to load');
        return;
    }
    
    const currentDeal = deals[currentDealId];
    console.log(' Loading deal data for:', currentDeal.name);
    console.log(' Deal data:', currentDeal);
    
    // Load global variables
    globalCaseStudies = currentDeal.globalCaseStudies || [];
    originalPitchContent = currentDeal.generatedPitch || '';
    bookmarkedCaseStudies = currentDeal.bookmarkedCaseStudies || [];
    stickyNotes = currentDeal.stickyNotes || [];
    selectedProducts = currentDeal.presalesFilters?.products || [];
    storedMarketInsights = currentDeal.marketInsights;
    storedCompanyInsights = currentDeal.companyInsights;
    
    console.log(' Loaded bookmarks:', bookmarkedCaseStudies.length);
    console.log(' Loaded notes:', stickyNotes.length);
    console.log(' Loaded case studies:', globalCaseStudies.length);
    console.log(' Loaded pitch content:', originalPitchContent ? 'Yes' : 'No');
    
    // Update localStorage for bookmarks and notes
    localStorage.setItem('bookmarkedCaseStudies', JSON.stringify(bookmarkedCaseStudies));
    localStorage.setItem('stickyNotes', JSON.stringify(stickyNotes));
    
    // Load form data immediately (not in setTimeout)
    if (currentDeal.presalesFilters) {
        const filters = currentDeal.presalesFilters;
        console.log(' Loading presales filters:', filters);
        setElementValue('presalesIndustry', filters.industry);
        setElementValue('presalesCompany', filters.company);
        setElementValue('presalesRegion', filters.region);
        setElementValue('presalesPrompt', filters.prompt);
        selectedProducts = filters.products || [];
        updateProductDisplay();
    }
    
    if (currentDeal.postsalesFilters) {
        const filters = currentDeal.postsalesFilters;
        console.log(' Loading postsales filters:', filters);
        setElementValue('postsalesIndustry', filters.industry);
        setElementValue('postsalesRegion', filters.region);
        setElementValue('postsalesUseCase', filters.useCase);
        setElementValue('postsalesProduct', filters.product);
        setElementValue('postsalesPrompt', filters.prompt);
        setElementValue('pitchType', filters.pitchType);
        setElementValue('targetCompany', filters.targetCompany);
        setElementValue('additionalContext', filters.additionalContext);
    }
    
    // Update UI
    updateBookmarkCount();
    displayStickyNotes();
    updateUseCaseDisplay();
    
    // Handle workflow restoration
    if (currentDeal.currentWorkflow) {
        console.log(' Restoring workflow:', currentDeal.currentWorkflow);
        
        // If we're on the start page, don't auto-load workflow
        if (!document.getElementById('workflowSelectorMain').classList.contains('hidden')) {
            console.log(' Staying on start page, workflow will be restored when user selects');
        } else {
            // User is already in a workflow, restore it
            currentWorkflow = currentDeal.currentWorkflow;
            switchWorkflow(currentWorkflow);
            
            // Restore pitch if exists - WITH DELAY to ensure DOM is ready
            setTimeout(() => {
                if (originalPitchContent) {
                    console.log(' Restoring pitch content');
                    displayPitch(originalPitchContent);
                }
            }, 200);
            
            // Restore case studies if exist
            if (globalCaseStudies.length > 0) {
                displayCaseStudiesGrid(globalCaseStudies);
                document.getElementById('exploreResultsContainer').classList.remove('hidden');
            }
        }
    }
    
    console.log(' Deal data loaded successfully');
}

function setElementValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element && value !== undefined && value !== null) {
        element.value = value;
        console.log(` Set ${elementId} to:`, value);
    } else if (!element) {
        console.log(` Element ${elementId} not found`);
    }
}

function resetUIState() {
    // Hide results containers
    document.getElementById('exploreResultsContainer').classList.add('hidden');
    document.getElementById('pitchSection').classList.add('hidden');
    document.getElementById('postsalesCaseStudiesSection').classList.add('hidden');
    document.getElementById('strategicSummarySection').classList.add('hidden');
    
    // Clear content areas
    document.getElementById('caseStudiesGrid').innerHTML = '';
    document.getElementById('pitchContent').innerHTML = '';
    document.getElementById('trendsContent').innerHTML = '';
    document.getElementById('companyContent').innerHTML = '';
}

// Modal functions
function showNewDealModal() {
    document.getElementById('newDealModal').classList.add('active');
}

function showManageDealsModal() {
    updateDealsList();
    document.getElementById('manageDealsModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function createNewDeal(event) {
    event.preventDefault();
    
    const name = document.getElementById('dealName').value;
    const client = document.getElementById('clientName').value;
    const description = document.getElementById('dealDescription').value;
    
    const newDeal = createEmptyDealData();
    newDeal.id = dealIdCounter++;
    newDeal.name = name;
    newDeal.client = client;
    newDeal.description = description;
    
    // Save current deal data before switching
    if (currentDealId) {
        saveCurrentDealData();
    }
    
    // Add new deal and switch to it
    deals[newDeal.id] = newDeal;
    currentDealId = newDeal.id;
    currentDealName = newDeal.name;
    
    localStorage.setItem('deals', JSON.stringify(deals));
    localStorage.setItem('dealIdCounter', dealIdCounter.toString());
    localStorage.setItem('currentDealId', currentDealId);
    
    // Reset form
    document.getElementById('dealName').value = '';
    document.getElementById('clientName').value = '';
    document.getElementById('dealDescription').value = '';
    
    // Update UI
    updateDealDropdown(); // This will now properly update the dropdown
    updateCurrentDealInfo();
    loadCurrentDealData();
    resetUIState();
    closeModal('newDealModal');
    
    console.log(' New deal created:', newDeal.name);
}

function updateDealsList() {
    const list = document.getElementById('dealsList');
    list.innerHTML = '';
    
    Object.values(deals).forEach(deal => {
        const dealItem = document.createElement('div');
        dealItem.className = 'p-4 border border-slate-200 rounded-lg mb-3';
        dealItem.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-medium text-slate-900">${deal.name}</h4>
                    <p class="text-sm text-slate-600">${deal.client || 'No client specified'}</p>
                    <p class="text-xs text-slate-500 mt-1">Created: ${new Date(deal.createdAt).toLocaleDateString()}</p>
                    <p class="text-xs text-slate-500">Last modified: ${new Date(deal.lastModified).toLocaleDateString()}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="duplicateDeal(${deal.id})" class="deal-btn secondary text-xs">Duplicate</button>
                    ${Object.keys(deals).length > 1 ? `<button onclick="deleteDeal(${deal.id})" class="deal-btn text-xs" style="background: #ef4444;">Delete</button>` : ''}
                </div>
            </div>
        `;
        list.appendChild(dealItem);
    });
}

function duplicateDeal(dealId) {
    const originalDeal = deals[dealId];
    const newDeal = JSON.parse(JSON.stringify(originalDeal)); // Deep copy
    
    newDeal.id = dealIdCounter++;
    newDeal.name = originalDeal.name + ' (Copy)';
    newDeal.createdAt = new Date().toISOString();
    newDeal.lastModified = new Date().toISOString();
    
    deals[newDeal.id] = newDeal;
    localStorage.setItem('deals', JSON.stringify(deals));
    localStorage.setItem('dealIdCounter', dealIdCounter.toString());
    
    updateDealDropdown();
    updateDealsList();
}

function deleteDeal(dealId) {
    if (Object.keys(deals).length === 1) {
        alert('Cannot delete the last remaining deal.');
        return;
    }
    
    if (confirm('Are you sure you want to delete this deal? All data will be lost.')) {
        delete deals[dealId];
        
        // If deleting current deal, switch to another
        if (dealId == currentDealId) {
            const remainingDealIds = Object.keys(deals);
            currentDealId = remainingDealIds[0];
            localStorage.setItem('currentDealId', currentDealId);
            loadCurrentDealData();
        }
        
        localStorage.setItem('deals', JSON.stringify(deals));
        updateDealDropdown();
        updateDealsList();
    }
}

function exportDeal() {
    if (!currentDealId || !deals[currentDealId]) return;
    
    const deal = deals[currentDealId];
    const exportData = {
        dealInfo: {
            name: deal.name,
            client: deal.client,
            description: deal.description,
            createdAt: deal.createdAt,
            lastModified: deal.lastModified
        },
        bookmarkedCaseStudies: deal.bookmarkedCaseStudies,
        generatedPitch: deal.generatedPitch,
        stickyNotes: deal.stickyNotes,
        filters: {
            presales: deal.presalesFilters,
            postsales: deal.postsalesFilters
        }
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `deal_${deal.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

        // Multi-select functionality
        function toggleMultiSelect(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('open');
            
            // Close other dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('open');
                }
            });
        }

        function initializeMultiSelect() {
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.multi-select')) {
                    document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                        d.classList.remove('open');
                    });
                }
            });

            // Initialize product multi-select
            document.querySelectorAll('#presalesProductDropdown .multi-select-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    toggleProductSelection(value);
                });
            });
        }

        function toggleProductSelection(value) {
            const index = selectedProducts.indexOf(value);
            if (index > -1) {
                selectedProducts.splice(index, 1);
            } else {
                selectedProducts.push(value);
            }
            updateProductDisplay();
            updateProductDropdown();
        }

        function updateProductDisplay() {
            const display = document.getElementById('presalesProductDisplay');
            const tagsContainer = document.getElementById('presalesProductTags');
            
            if (selectedProducts.length === 0) {
                display.textContent = 'Select products...';
                tagsContainer.innerHTML = '';
            } else {
                display.textContent = `${selectedProducts.length} product${selectedProducts.length > 1 ? 's' : ''} selected`;
                tagsContainer.innerHTML = selectedProducts.map(product => 
                    `<div class="tag">
                        ${product}
                        <span class="tag-remove" onclick="removeProduct('${product}')"></span>
                    </div>`
                ).join('');
            }
        }

        function updateProductDropdown() {
            document.querySelectorAll('#presalesProductDropdown .multi-select-option').forEach(option => {
                const value = option.dataset.value;
                option.classList.toggle('selected', selectedProducts.includes(value));
            });
        }

        function removeProduct(value) {
            const index = selectedProducts.indexOf(value);
            if (index > -1) {
                selectedProducts.splice(index, 1);
                updateProductDisplay();
                updateProductDropdown();
            }
        }
// Extract use cases from bookmarked case studies
function extractUseCasesFromBookmarks() {
    if (bookmarkedCaseStudies.length === 0) {
        return [];
    }
    
    const useCases = new Set();
    bookmarkedCaseStudies.forEach(caseStudy => {
        if (caseStudy.use_case && caseStudy.use_case !== 'N/A') {
            // Split by comma and clean up each use case
            caseStudy.use_case.split(',').forEach(useCase => {
                const cleanUseCase = useCase.trim();
                if (cleanUseCase && cleanUseCase !== 'N/A') {
                    useCases.add(cleanUseCase);
                }
            });
        }
    });
    
    return Array.from(useCases);
}
        // Workflow selection
function selectWorkflow(workflow) {
    currentWorkflow = workflow;
    
    // Hide workflow selector and show main content immediately
    document.getElementById('workflowSelectorMain').classList.add('hidden');
    document.getElementById('workflowSelectorMini').classList.remove('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    
    // Show all UI elements INCLUDING the deal toggle
    document.getElementById('dealToggle').style.display = 'flex';
    document.getElementById('navMiniPanel').style.display = 'flex';
    document.getElementById('toggleButtons').style.display = 'flex';
    
    // Actually switch to the workflow page immediately
    switchWorkflow(workflow);
    updateSlidingIndicator();
    updateNavigationPanel();
    initializeMultiSelect();
    
    // Save workflow selection to current deal
    if (currentDealId && deals[currentDealId]) {
        deals[currentDealId].currentWorkflow = workflow;
        saveCurrentDealData();
    }
}
// Global state management for background processes
let backgroundProcesses = {
    marketInsights: {
        isRunning: false,
        controller: null,
        completed: false
    },
    companyIntelligence: {
        isRunning: false,
        controller: null,
        completed: false
    }
};

// Enhanced workflow switching that preserves background processes
function switchWorkflow(workflow) {
    console.log(` Switching to ${workflow} workflow`);
    
    currentWorkflow = workflow;
    
    // Hide all workflows first
    document.getElementById('presalesWorkflow').classList.add('hidden');
    document.getElementById('postsalesWorkflow').classList.add('hidden');
    
    // Show selected workflow immediately
    document.getElementById(workflow + 'Workflow').classList.remove('hidden');
    
    // Update mini tabs
    document.getElementById('presalesTabMini').classList.toggle('active', workflow === 'presales');
    document.getElementById('postsalesTabMini').classList.toggle('active', workflow === 'postsales');
    
    // Update navigation elements
    updateSlidingIndicator();
    updateNavigationPanel();
    
    // Handle workflow-specific logic
    if (workflow === 'postsales') {
        updateUseCaseDisplay();
    } else if (workflow === 'presales') {
        // If switching back to presales, display completed insights
        if (backgroundProcesses.marketInsights.completed && storedMarketInsights) {
            displayMarketTrends({ aggregate_insights: storedMarketInsights });
        }
        if (backgroundProcesses.companyIntelligence.completed && storedCompanyInsights) {
            displayCompanyIntelligence(storedCompanyInsights);
        }
    }
    
    console.log(' Workflow switched without interrupting background processes');
}

        function updateSlidingIndicator() {
            const indicator = document.getElementById('slidingIndicator');
            const activeTab = document.querySelector('.glass-tab.active');
            if (activeTab) {
                indicator.style.left = (activeTab.offsetLeft) + 'px';
                indicator.style.width = activeTab.offsetWidth + 'px';
            }
        }

        // Filter toggle functionality
        function toggleFilters(filterId) {
            const content = document.getElementById(filterId);
            const icon = document.getElementById(filterId + 'Icon');
            
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        // Case study exploration
async function exploreCaseStudies() {
    // Validate mandatory fields
    const industry = document.getElementById('presalesIndustry').value;
    const company = document.getElementById('presalesCompany').value.trim();
    const selectedProductsCount = selectedProducts.length;
    
    // Check if mandatory fields are filled
    const missingFields = [];
    if (!industry) missingFields.push('Industry');
    if (!company) missingFields.push('Company Name');
    if (selectedProductsCount === 0) missingFields.push('Product');
    
    if (missingFields.length > 0) {
        alert(`Please fill in the following mandatory fields:\n ${missingFields.join('\n ')}`);
        return;
    }
    
    // Reset background processes state for new search
    backgroundProcesses.marketInsights.completed = false;
    backgroundProcesses.companyIntelligence.completed = false;
    hasMarketInsights = false;
    hasCompanyInsights = false;
    
    const region = document.getElementById('presalesRegion').value || 'World';
    const product = selectedProducts.join(',');
    const prompt = document.getElementById('presalesPrompt').value;

    currentFilters = { industry, company, region, product, prompt };
    console.log('currentFilters set to:', currentFilters);

    const searchQuery = { industry, company, region, product, prompt };

    try {
        const btn = document.getElementById('exploreBtn');
        const btnText = document.getElementById('exploreBtnText');
        btn.disabled = true;
        btnText.innerHTML = '<span class="loading-spinner mr-2"></span>Exploring...';

        const response = await fetch('/explore_case_studies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(searchQuery)
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }

        globalCaseStudies = data.case_studies || [];
        displayCaseStudiesGrid(globalCaseStudies);
        
        // Start background insights generation (these continue even if user switches workflows)
        setTimeout(() => {
            console.log(' Starting background insights generation...');
            refreshMarketTrends(); // Runs in background
            
            if (company) {
                setTimeout(() => {
                    fetchCompanyIntelligence(); // Also runs in background
                }, 1000);
            }
        }, 500);

        // Show make pitch button if we have results
        const makePitchBtn = document.getElementById('makePitchBtn');
        if (makePitchBtn) {
            makePitchBtn.style.display = globalCaseStudies.length > 0 ? 'inline-flex' : 'none';
        }
        
        // Show the dark container with results
        document.getElementById('exploreResultsContainer').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error exploring case studies. Please try again.');
    } finally {
        const btn = document.getElementById('exploreBtn');
        const btnText = document.getElementById('exploreBtnText');
        btn.disabled = false;
        btnText.textContent = 'Explore Scope';
    }
}
function autofillGenerateFilters() {
    // Get values from explore page
    const industry = document.getElementById('presalesIndustry').value;
    const company = document.getElementById('presalesCompany').value;
    const region = document.getElementById('presalesRegion').value;
    const product = selectedProducts.length > 0 ? selectedProducts[0] : '';
    const prompt = document.getElementById('presalesPrompt').value;

    // Set values in generate page
    document.getElementById('postsalesIndustry').value = industry;
    document.getElementById('targetCompany').value = company;
    document.getElementById('postsalesRegion').value = region;
    document.getElementById('postsalesProduct').value = product;
    document.getElementById('postsalesPrompt').value = prompt;

    // Extract use cases from bookmarked case studies
    const bookmarkedUseCases = extractUseCasesFromBookmarks();
    
    // Auto-detect use case from bookmarks first, then from prompt
    const useCaseElement = document.getElementById('postsalesUseCase');
    
    if (bookmarkedUseCases.length > 0) {
        const availableOptions = Array.from(useCaseElement.options).map(opt => opt.value).filter(val => val);
        
        let matchingUseCase = null;
        for (const bookmarkedUseCase of bookmarkedUseCases) {
            const exactMatch = availableOptions.find(option => 
                option.toLowerCase() === bookmarkedUseCase.toLowerCase()
            );
            if (exactMatch) {
                matchingUseCase = exactMatch;
                break;
            }
            
            const partialMatch = availableOptions.find(option => 
                option.toLowerCase().includes(bookmarkedUseCase.toLowerCase()) || 
                bookmarkedUseCase.toLowerCase().includes(option.toLowerCase())
            );
            if (partialMatch) {
                matchingUseCase = partialMatch;
                break;
            }
        }
        
        if (matchingUseCase) {
            useCaseElement.value = matchingUseCase;
        }
    } else {
        // Fallback to prompt-based detection if no bookmarks
        const promptLower = prompt.toLowerCase();
        
        if (promptLower.includes('digital transform')) {
            useCaseElement.value = 'Digital Transformation';
        } else if (promptLower.includes('cloud')) {
            useCaseElement.value = 'Cloud';
        } else if (promptLower.includes('security') || promptLower.includes('cyber')) {
            useCaseElement.value = 'Cybersecurity';
        } else if (promptLower.includes('analytic') || promptLower.includes('data')) {
            useCaseElement.value = 'Analytics';
        } else if (promptLower.includes('automation')) {
            if (promptLower.includes('business')) {
                useCaseElement.value = 'Business automation';
            } else {
                useCaseElement.value = 'IT Automation';
            }
        }
    }
    
    console.log(' Filters autofilled from background insights');
}
async function makePitchFromExplore() {
    // Check if we have explored case studies or bookmarks
    if (globalCaseStudies.length === 0 && bookmarkedCaseStudies.length === 0) {
        alert('Please explore case studies first or bookmark some case studies before making a pitch');
        return;
    }

    const btn = document.getElementById('makePitchBtn');
    const originalText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner mr-2"></span>Preparing pitch...';

        // Switch to generate workflow
        switchWorkflow('postsales');
        
        // Autofill the filters
        autofillGenerateFilters();
        
        // Wait a moment for UI to update
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Scroll to top of generate page
        document.getElementById('postsalesWorkflow').scrollIntoView({ behavior: 'smooth' });
        
        // Auto-generate the pitch
        await generatePitch();
        
    } catch (error) {
        console.error('Error making pitch:', error);
        alert(`Error creating pitch: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
        function displayCaseStudiesGrid(caseStudies) {
            const section = document.getElementById('caseStudiesSection');
            const grid = document.getElementById('caseStudiesGrid');
            const count = document.getElementById('caseStudiesCount');
            
            if (caseStudies.length === 0) {
                count.textContent = '0 results found';
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">No case studies found matching your criteria.</div>';
                return;
            }

            count.textContent = `${caseStudies.length} result${caseStudies.length !== 1 ? 's' : ''} found`;
            
            grid.innerHTML = '';
            
            caseStudies.forEach(caseStudy => {
                const isBookmarked = bookmarkedCaseStudies.some(b => String(b.id) === String(caseStudy.id));
                
                const card = document.createElement('div');
                card.className = 'case-study-card-content relative';
                card.innerHTML = `
                    <button onclick="toggleBookmark('${caseStudy.id}')" class="bookmark-btn ${isBookmarked ? 'bookmarked' : ''}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </button>
                    
                    ${caseStudy.use_case ? `
                        <div class="mb-4">
                            <h5 class="text-sm font-medium mb-2">Use Cases</h5>
                            <div class="space-y-1">
                                ${caseStudy.use_case.split(',').map(useCase => 
                                    `<div class="use-case-highlight">${useCase.trim()}</div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${caseStudy.key_results ? `
                        <div class="mb-4">
                            <h5 class="text-sm font-medium text-slate-700 mb-2">Key Improvements</h5>
                            <ul class="space-y-1 text-sm text-slate-600">
                                ${caseStudy.key_results.split(';').slice(0, 3).map(result => 
                                    result.trim() ? `<li class="flex items-start"><span class="text-green-600 mr-2"></span><span>${result.trim()}</span></li>` : ''
                                ).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="mb-4">
                        <h4 class="text-xl font-semibold text-slate-900 mb-2">${caseStudy.company || 'Unknown Company'}</h4>
                        <div class="flex flex-wrap gap-2">
                            ${caseStudy.industry ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${caseStudy.industry}</span>` : ''}
                            ${caseStudy.region ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">${caseStudy.region}</span>` : ''}
                            ${caseStudy.company_size ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">${caseStudy.company_size}</span>` : ''}
                        </div>
                    </div>

                    ${caseStudy.product ? `
                        <div class="mb-4">
                            <h5 class="text-sm font-medium text-slate-700 mb-1">Products</h5>
                          <p class="text-sm text-slate-600" style="color: var(--text-dark) !important;">${caseStudy.product}</p>
                        </div>
                    ` : ''}

                    ${caseStudy.source ? `
                        <div class="mt-auto pt-4 border-t border-slate-200">
                            <a href="${caseStudy.source}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                View Details 
                            </a>
                        </div>
                    ` : ''}
                `;
                
                grid.appendChild(card);
            });
        }

      function extractUseCasesFromCaseStudies(caseStudies) {
    console.log(' extractUseCasesFromCaseStudies called with:', caseStudies);
    
    if (!caseStudies || caseStudies.length === 0) {
        console.log(' No case studies provided');
        return [];
    }
    
    const allUseCases = [];
    
    caseStudies.forEach((caseStudy, index) => {
        console.log(` Processing case study ${index + 1}: ${caseStudy.company}`);
        
        if (caseStudy.use_case && caseStudy.use_case !== 'N/A' && caseStudy.use_case.trim()) {
            // Split by comma and add each use case from this case study
            const useCases = caseStudy.use_case.split(',');
            console.log(`- Raw use cases:`, useCases);
            
            useCases.forEach(useCase => {
                const cleanUseCase = useCase.trim();
                if (cleanUseCase && cleanUseCase !== 'N/A' && cleanUseCase.length > 2) {
                    // Add company name for context: "Use Case (Company)"
                    const useCaseWithCompany = `${cleanUseCase} (${caseStudy.company})`;
                    allUseCases.push(useCaseWithCompany);
                    console.log(` Added use case: "${useCaseWithCompany}"`);
                }
            });
        } else {
            console.log(` No valid use case found for case study: ${caseStudy.company}`);
        }
    });
    
    console.log(' All extracted use cases:', allUseCases);
    return allUseCases.slice(0, 5); // Show first 5 use cases
}

// Enhanced executive summary extraction function
function extractExecutiveSummary(text) {
    if (!text) {
        console.log('No text provided to extractExecutiveSummary');
        return null;
    }
    
    console.log('Extracting executive summary from text:', text.substring(0, 400) + '...');
    
    // Try to find executive summary section
    const patterns = [
        /(?:^|\n)(?:1\.\s*)?EXECUTIVE SUMMARY\s*\n(.*?)(?:\n\n|\n(?:2\.|[A-Z][A-Z\s]*(?:\(|:))|\n---|\Z)/is,
        /(?:^|\n)EXECUTIVE SUMMARY\s*:?\s*\n(.*?)(?:\n\n|\n(?:[0-9]+\.|[A-Z][A-Z\s]*(?:\(|:))|\n---|\Z)/is
    ];
    
    let summaryMatch = null;
    for (const pattern of patterns) {
        summaryMatch = text.match(pattern);
        if (summaryMatch && summaryMatch[1].trim()) {
            console.log('Found executive summary section');
            break;
        }
    }
    
    if (summaryMatch && summaryMatch[1]) {
        const summaryText = summaryMatch[1].trim();
        console.log('Raw summary text:', summaryText);
        
        // Extract numbered points (1. 2. 3.) from the executive summary
        const numberedPoints = [];
        
        // Look for numbered list pattern: "1. text 2. text 3. text"
        const pointMatches = summaryText.match(/(\d+\.\s*[^0-9]+?)(?=\d+\.|$)/g);
        
        if (pointMatches) {
            pointMatches.forEach(point => {
                const cleanPoint = point.replace(/^\d+\.\s*/, '').trim();
                if (cleanPoint) {
                    numberedPoints.push(cleanPoint);
                }
            });
        }
        
        console.log('Extracted numbered points:', numberedPoints);
        
        if (numberedPoints.length > 0) {
            return {
                bullet_points: numberedPoints.slice(0, 3) // Max 3 points
            };
        }
    }
    
    console.log('No numbered points found in executive summary');
    return null;
}

        // Auto-generate strategic summary when both insights are available
function checkAndGenerateSummary() {
    console.log(' checkAndGenerateSummary called');
    console.log(' hasMarketInsights:', hasMarketInsights);
    console.log(' hasCompanyInsights:', hasCompanyInsights);
    console.log(' globalCaseStudies.length:', globalCaseStudies.length);
    
    // If strategic summary is already visible, just update it with new insights
    const summarySection = document.getElementById('strategicSummarySection');
    if (!summarySection.classList.contains('hidden') && globalCaseStudies.length > 0) {
        console.log(' Updating existing strategic summary with new insights');
        displayStrategicSummary(); // This will refresh with latest insights
    }
    // If we have case studies but summary not shown yet, show it
    else if (globalCaseStudies.length > 0) {
        console.log(' Showing strategic summary for the first time');
        displayStrategicSummary();
    }
}

function displayStrategicSummary() {
    console.log(' displayStrategicSummary called');
    
    const section = document.getElementById('strategicSummarySection');
    
    // Extract ALL use cases from case studies (not unique)
    const useCasesFromCaseStudies = extractUseCasesFromCaseStudies(globalCaseStudies);
    
    // Get executive summaries (these might be null initially)
    const marketSummary = storedMarketInsights?.executive_summary;
    const companySummary = storedCompanyInsights?.executive_summary;
    
    console.log(' Use cases to display:', useCasesFromCaseStudies);
    console.log(' Market summary to display:', marketSummary);
    console.log(' Company summary to display:', companySummary);
    
    // Update display
    updateStrategicSummaryDisplay(useCasesFromCaseStudies, companySummary, marketSummary);
    
    // Show the section
    section.classList.remove('hidden');
    section.style.display = 'block';
    
    // Scroll to it
    setTimeout(() => {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function checkAndGenerateSummary() {
    console.log(' checkAndGenerateSummary called');
    console.log(' hasMarketInsights:', hasMarketInsights);
    console.log(' hasCompanyInsights:', hasCompanyInsights);
    console.log(' globalCaseStudies.length:', globalCaseStudies.length);
    
    // If strategic summary is already visible, just update it with new insights
    const summarySection = document.getElementById('strategicSummarySection');
    if (!summarySection.classList.contains('hidden') && globalCaseStudies.length > 0) {
        console.log(' Updating existing strategic summary with new insights');
        displayStrategicSummary(); // This will refresh with latest insights
    }
    // If we have case studies but summary not shown yet, show it
    else if (globalCaseStudies.length > 0) {
        console.log(' Showing strategic summary for the first time');
        displayStrategicSummary();
    }
}



// Add this debugging function
function debugStrategicSummaryData() {
    console.log('=== DEBUGGING STRATEGIC SUMMARY DATA ===');
    console.log('storedMarketInsights:', storedMarketInsights);
    console.log('storedCompanyInsights:', storedCompanyInsights);
    
    if (storedMarketInsights && storedMarketInsights.insights) {
        console.log('Market insights text:', storedMarketInsights.insights);
        console.log('Market insights text length:', storedMarketInsights.insights.length);
        
        // Test the extraction
        const marketSummary = extractExecutiveSummary(storedMarketInsights.insights);
        console.log('Extracted market summary:', marketSummary);
    }
    
    if (storedCompanyInsights && storedCompanyInsights.key_insights) {
        console.log('Company insights text:', storedCompanyInsights.key_insights);
        console.log('Company insights text length:', storedCompanyInsights.key_insights.length);
        
        // Test the extraction
        const companySummary = extractExecutiveSummary(storedCompanyInsights.key_insights);
        console.log('Extracted company summary:', companySummary);
    }
}
        let storedMarketInsights = null;
        let storedCompanyInsights = null;

// Add this new function to your index.html JavaScript
function extractMarketExecutiveSummary(insightsText) {
    if (!insightsText) {
        console.log('No market insights text provided');
        return null;
    }
    
    console.log('Extracting market executive summary from text:', insightsText.substring(0, 400) + '...');
    
    // Try to find executive summary section first
    const executiveSummaryPatterns = [
        /(?:^|\n)(?:1\.\s*)?EXECUTIVE SUMMARY\s*\n(.*?)(?:\n\n|\n(?:2\.|[A-Z][A-Z\s]*(?:\(|:))|\n---|\Z)/is,
        /(?:^|\n)EXECUTIVE SUMMARY\s*:?\s*\n(.*?)(?:\n\n|\n(?:[0-9]+\.|[A-Z][A-Z\s]*(?:\(|:))|\n---|\Z)/is
    ];
    
    let summaryMatch = null;
    for (const pattern of executiveSummaryPatterns) {
        summaryMatch = insightsText.match(pattern);
        if (summaryMatch && summaryMatch[1].trim()) {
            console.log('Found executive summary section');
            break;
        }
    }
    
    if (summaryMatch && summaryMatch[1]) {
        const summaryText = summaryMatch[1].trim();
        console.log('Raw summary text:', summaryText);
        
        // Extract numbered points (1. 2. 3.) from the executive summary
        const numberedPoints = [];
        
        // Look for numbered list pattern: "1. text 2. text 3. text"
        const pointMatches = summaryText.match(/(\d+\.\s*[^0-9]+?)(?=\d+\.|$)/g);
        
        if (pointMatches) {
            pointMatches.forEach(point => {
                const cleanPoint = point.replace(/^\d+\.\s*/, '').trim();
                if (cleanPoint) {
                    numberedPoints.push(cleanPoint);
                }
            });
            
            console.log('Extracted numbered points from executive summary:', numberedPoints);
            
            if (numberedPoints.length > 0) {
                return {
                    bullet_points: numberedPoints.slice(0, 3) // Max 3 points
                };
            }
        }
    }
    
    // If no executive summary section found, extract key insights from the structured sections
    console.log('No executive summary section found, extracting from structured content...');
    
    const marketInsights = [];
    
    // Extract from KEY MARKET INSIGHTS section
    const marketInsightsMatch = insightsText.match(/KEY MARKET INSIGHTS.*?\n(.*?)(?:\n(?:[0-9]+\.|[A-Z][A-Z\s]*:)|\Z)/is);
    if (marketInsightsMatch) {
        const content = marketInsightsMatch[1];
        // Look for **bold headings**: content pattern
        const boldMatches = content.match(/\*\*(.*?)\*\*:\s*([^*]+?)(?=\*\*|\n\n|\Z)/gs);
        if (boldMatches && boldMatches.length > 0) {
            const firstInsight = boldMatches[0].replace(/\*\*(.*?)\*\*:\s*/, '').trim();
            if (firstInsight) {
                marketInsights.push(`Market analysis reveals ${firstInsight.toLowerCase()}`);
            }
        }
    }
    
    // Extract from BUSINESS OPPORTUNITIES section
    const opportunitiesMatch = insightsText.match(/BUSINESS OPPORTUNITIES.*?\n(.*?)(?:\n(?:[0-9]+\.|[A-Z][A-Z\s]*:)|\Z)/is);
    if (opportunitiesMatch) {
        const content = opportunitiesMatch[1];
        const boldMatches = content.match(/\*\*(.*?)\*\*:\s*([^*]+?)(?=\*\*|\n\n|\Z)/gs);
        if (boldMatches && boldMatches.length > 0) {
            const firstOpportunity = boldMatches[0].replace(/\*\*(.*?)\*\*:\s*/, '').trim();
            if (firstOpportunity) {
                marketInsights.push(`Key opportunities identified in ${firstOpportunity.toLowerCase()}`);
            }
        }
    }
    
    // Extract from STRATEGIC CHALLENGES section
    const challengesMatch = insightsText.match(/STRATEGIC CHALLENGES.*?\n(.*?)(?:\n(?:[0-9]+\.|[A-Z][A-Z\s]*:)|\Z)/is);
    if (challengesMatch) {
        const content = challengesMatch[1];
        const boldMatches = content.match(/\*\*(.*?)\*\*:\s*([^*]+?)(?=\*\*|\n\n|\Z)/gs);
        if (boldMatches && boldMatches.length > 0) {
            const firstChallenge = boldMatches[0].replace(/\*\*(.*?)\*\*:\s*/, '').trim();
            if (firstChallenge) {
                marketInsights.push(`Strategic focus on ${firstChallenge.toLowerCase()}`);
            }
        }
    }
    
    // If we found insights from structured sections, use them
    if (marketInsights.length > 0) {
        console.log('Extracted market insights from structured sections:', marketInsights);
        return {
            bullet_points: marketInsights.slice(0, 3) // Max 3 points
        };
    }
    
    // Final fallback: look for any bullet points in the text
    const allBullets = insightsText.split('\n')
        .filter(line => line.trim() && (line.includes('-') || line.includes('')))
        .map(line => line.replace(/^[-]\s*/, '').trim())
        .filter(line => line.length > 20); // Only substantial points
    
    if (allBullets.length > 0) {
        console.log('Using fallback bullet points:', allBullets.slice(0, 3));
        return {
            bullet_points: allBullets.slice(0, 3)
        };
    }
    
    console.log('No market insights found, using generic fallback');
    return null;
}

function displayMarketTrends(trends) {
    const content = document.getElementById('trendsContent');
    
    if (trends.aggregate_insights) {
        const insights = trends.aggregate_insights;
        const insightsText = insights.insights || '';
        
        // Use the enhanced market-specific executive summary extraction
        const executiveSummary = extractMarketExecutiveSummary(insightsText);
        
        // Parse the insights into three categories for the INSIGHTS SECTION
        const categorizedInsights = parseInsightsIntoCategories(insightsText);
        
        // Display the categorized insights in the insights section (as before)
        content.innerHTML = `
            <div class="grid gap-4">
                <!-- Pain Points & Challenges -->
                <div class="bg-white p-4 rounded-lg border border-red-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-red-900">Top Pain Points</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.painPoints}
                    </div>
                </div>

                <!-- Market Opportunities -->
                <div class="bg-white p-4 rounded-lg border border-green-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-green-900">Key Opportunities</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.opportunities}
                    </div>
                </div>

                <!-- Key Trends -->
                <div class="bg-white p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-blue-900">Emerging Trends</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.trends}
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-xs text-slate-500 text-center">
                Based on ${insights.based_on_articles} articles  ${insights.region}  
                <a href="javascript:void(0)" onclick="viewMarketTrendsDetails()" class="text-blue-600 hover:text-blue-800 transition-colors ml-1">
                    View Details 
                </a>
            </div>
        `;
        
        // Store market insights with ENHANCED executive summary
        storedMarketInsights = {
            ...insights,
            executive_summary: executiveSummary || {
                bullet_points: [
                    "Market analysis shows emerging opportunities in digital transformation",
                    "Industry trends indicate accelerated technology adoption",
                    "Competitive landscape reveals strategic investment priorities"
                ]
            }
        };
        hasMarketInsights = true;
        console.log('Market insights stored with ENHANCED executive summary:', storedMarketInsights.executive_summary);
        checkAndGenerateSummary();
    } else {
        content.innerHTML = `
            <div class="text-center py-8 text-slate-500">
                <p>No market insights available for this industry.</p>
            </div>
        `;
    }
}
function parseInsightsIntoCategories(insightsText) {
    if (!insightsText) {
        return {
            painPoints: 'No pain points identified.',
            opportunities: 'No opportunities identified.',
            trends: 'No trends identified.'
        };
    }

    // Since your prompt generates structured output, parse the sections
    const sections = {
        painPoints: [],
        opportunities: [],
        trends: []
    };

    try {
        // Look for the structured sections in the response
        const painPointsMatch = insightsText.match(/TOP PAIN POINTS.*?\n((?:[-]\s*.+\n?){1,3})/is);
        const opportunitiesMatch = insightsText.match(/KEY OPPORTUNITIES.*?\n((?:[-]\s*.+\n?){1,3})/is);
        const trendsMatch = insightsText.match(/EMERGING TRENDS.*?\n((?:[-]\s*.+\n?){1,3})/is);

        // Parse pain points
        if (painPointsMatch) {
            const painPoints = painPointsMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3); // Maximum 3 as per your prompt
            sections.painPoints = painPoints;
        }

        // Parse opportunities
        if (opportunitiesMatch) {
            const opportunities = opportunitiesMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3); // Maximum 3 as per your prompt
            sections.opportunities = opportunities;
        }

        // Parse trends
        if (trendsMatch) {
            const trends = trendsMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3); // Maximum 3 as per your prompt
            sections.trends = trends;
        }

        // If structured parsing failed, try to extract bullet points from the entire text
        if (sections.painPoints.length === 0 && sections.opportunities.length === 0 && sections.trends.length === 0) {
            const allBullets = insightsText.split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .filter(line => line.length > 0);

            // Distribute bullets across sections (max 3 each)
            const third = Math.ceil(allBullets.length / 3);
            sections.painPoints = allBullets.slice(0, Math.min(3, third));
            sections.opportunities = allBullets.slice(third, Math.min(allBullets.length, third + 3));
            sections.trends = allBullets.slice(third * 2, Math.min(allBullets.length, third * 2 + 3));
        }

    } catch (error) {
        console.log('Error parsing structured insights:', error);
        // Fallback to simple text
        return {
            painPoints: 'Market challenges identified through analysis',
            opportunities: 'Growth opportunities available in current market',
            trends: 'Technology trends driving industry transformation'
        };
    }

    // Format the results with proper HTML
    return {
        painPoints: sections.painPoints.length > 0 ? 
            sections.painPoints.map(point => `<div class="flex items-start mb-2">
                <span class="text-red-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">No specific pain points identified</div>',
        
        opportunities: sections.opportunities.length > 0 ? 
            sections.opportunities.map(point => `<div class="flex items-start mb-2">
                <span class="text-green-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Market opportunities under analysis</div>',
        
        trends: sections.trends.length > 0 ? 
            sections.trends.map(point => `<div class="flex items-start mb-2">
                <span class="text-blue-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Emerging trends being monitored</div>'
    };
}
function formatBoldText(text) {
    // Handle **text*: pattern (bold text with missing closing asterisk)
    text = text.replace(/\*\*(.*?)\*:/g, '<strong class="font-semibold">$1</strong>:');
    
    // Handle **text**: pattern (bold text followed by colon)
    text = text.replace(/\*\*(.*?)\*\*:/g, '<strong class="font-semibold">$1</strong>:');
    
    // Handle **text** pattern (text completely surrounded by asterisks)
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
    
    // Handle any remaining single asterisks
    text = text.replace(/\*/g, '');
    
    return text;
}
        // Company intelligence
   // Fixed company intelligence with better error handling and loading management
async function fetchCompanyIntelligence() {
    const company = document.getElementById('presalesCompany').value.trim();
    const daysBack = 7;
    
    if (!company) {
        console.log(' No company name provided for intelligence');
        return;
    }
    
    // Check if already running for this company
    if (backgroundProcesses.companyIntelligence.isRunning) {
        console.log(' Company intelligence already processing in background');
        return backgroundProcesses.companyIntelligence.promise;
    }
    
    // Check if already completed for this company
    if (backgroundProcesses.companyIntelligence.completed && storedCompanyInsights && 
        storedCompanyInsights.company === company) {
        console.log(' Company intelligence already available for', company);
        if (currentWorkflow === 'presales') {
            displayCompanyIntelligence(storedCompanyInsights);
        }
        return Promise.resolve(storedCompanyInsights);
    }
    
    // Mark as running BEFORE starting the request
    backgroundProcesses.companyIntelligence.isRunning = true;
    backgroundProcesses.companyIntelligence.completed = false;
    
    // Show loading state only if user is on presales workflow
    if (currentWorkflow === 'presales') {
        document.getElementById('companyLoading').classList.remove('hidden');
        document.getElementById('companyContent').innerHTML = '';
    }
    
    console.log(' Starting company intelligence analysis for:', company);
    
    try {
        // Create AbortController for this request
        const controller = new AbortController();
        backgroundProcesses.companyIntelligence.controller = controller;
        
        // Create and store the promise
        const fetchPromise = fetch('/fetch_company_intelligence', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ company_name: company, days_back: daysBack }),
            signal: controller.signal
        });
        
        backgroundProcesses.companyIntelligence.promise = fetchPromise;
        
        const response = await fetchPromise;
        
        console.log(' Company intelligence response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to fetch intelligence`);
        }
        
        const data = await response.json();
        console.log(' Company intelligence data received:', data);
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.intelligence) {
            throw new Error('No intelligence data received');
        }
        
        // Store the insights globally
        storedCompanyInsights = {
            ...data.intelligence,
            executive_summary: data.intelligence.executive_summary || {
                bullet_points: [
                    `Recent strategic developments for ${company}`,
                    `Business opportunities identified in market analysis`,
                    `Competitive positioning shows growth potential`
                ]
            }
        };
        
        // Mark as completed
        backgroundProcesses.companyIntelligence.completed = true;
        backgroundProcesses.companyIntelligence.isRunning = false;
        hasCompanyInsights = true;
        
        console.log(' Company intelligence completed and stored for:', company);
        console.log(' Executive summary:', storedCompanyInsights.executive_summary);
        
        // Update display only if user is currently on presales workflow
        if (currentWorkflow === 'presales') {
            displayCompanyIntelligence(data.intelligence);
        }
        
        // Update strategic summary regardless of current workflow
        checkAndGenerateSummary();
        
        return data.intelligence;
        
    } catch (error) {
        // Always mark as not running in error cases
        backgroundProcesses.companyIntelligence.isRunning = false;
        backgroundProcesses.companyIntelligence.completed = false;
        
        if (error.name === 'AbortError') {
            console.log(' Company intelligence request was cancelled');
            return null;
        }
        
        console.error(' Company intelligence error:', error);
        
        // Only show error if user is currently on presales workflow
        if (currentWorkflow === 'presales') {
            document.getElementById('companyContent').innerHTML = `
                <div class="text-center py-8 text-slate-500">
                    <p>Unable to fetch company intelligence: ${error.message}</p>
                    <button onclick="retryCompanyIntelligence()" class="btn-secondary mt-2">Retry</button>
                </div>
            `;
        }
        
        throw error;
        
    } finally {
        // ALWAYS hide loading state regardless of success/failure
        if (currentWorkflow === 'presales') {
            document.getElementById('companyLoading').classList.add('hidden');
        }
        
        // Clean up the running state if still marked as running
        if (backgroundProcesses.companyIntelligence.isRunning) {
            backgroundProcesses.companyIntelligence.isRunning = false;
        }
    }
}

// Fixed market trends function with the same improvements
async function refreshMarketTrends() {
    const industry = document.getElementById('presalesIndustry').value || 'Technology';
    
    // Check if already running
    if (backgroundProcesses.marketInsights.isRunning) {
        console.log(' Market insights already processing in background');
        return backgroundProcesses.marketInsights.promise;
    }
    
    // Check if already completed
    if (backgroundProcesses.marketInsights.completed && storedMarketInsights) {
        console.log(' Market insights already available');
        if (currentWorkflow === 'presales') {
            displayMarketTrends({ aggregate_insights: storedMarketInsights });
        }
        return Promise.resolve(storedMarketInsights);
    }
    
    // Mark as running BEFORE starting the request
    backgroundProcesses.marketInsights.isRunning = true;
    backgroundProcesses.marketInsights.completed = false;
    
    // Show loading state only if user is on presales workflow
    if (currentWorkflow === 'presales') {
        document.getElementById('trendsLoading').classList.remove('hidden');
        document.getElementById('trendsContent').innerHTML = '';
    }
    
    console.log(' Starting market trends analysis for:', industry);
    
    try {
        // Create AbortController for this request
        const controller = new AbortController();
        backgroundProcesses.marketInsights.controller = controller;
        
        // Create and store the promise
        const fetchPromise = fetch('/fetch_market_trends', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ industry }),
            signal: controller.signal
        });
        
        backgroundProcesses.marketInsights.promise = fetchPromise;
        
        const response = await fetchPromise;
        
        console.log(' Market trends response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to fetch trends`);
        }
        
        const data = await response.json();
        console.log(' Market trends data received:', data);
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.trends || !data.trends.aggregate_insights) {
            throw new Error('No market insights data received');
        }
        
        // Store the insights globally
        storedMarketInsights = {
            ...data.trends.aggregate_insights,
            executive_summary: extractMarketExecutiveSummary(data.trends.aggregate_insights.insights)
        };
        
        // Mark as completed
        backgroundProcesses.marketInsights.completed = true;
        backgroundProcesses.marketInsights.isRunning = false;
        hasMarketInsights = true;
        
        console.log(' Market insights completed and stored');
        console.log(' Executive summary:', storedMarketInsights.executive_summary);
        
        // Update display only if user is currently on presales workflow
        if (currentWorkflow === 'presales') {
            displayMarketTrends(data.trends);
        }
        
        // Update strategic summary regardless of current workflow
        checkAndGenerateSummary();
        
        return data.trends.aggregate_insights;
        
    } catch (error) {
        // Always mark as not running in error cases
        backgroundProcesses.marketInsights.isRunning = false;
        backgroundProcesses.marketInsights.completed = false;
        
        if (error.name === 'AbortError') {
            console.log(' Market trends request was cancelled');
            return null;
        }
        
        console.error(' Market trends error:', error);
        
        // Only show error if user is currently on presales workflow
        if (currentWorkflow === 'presales') {
            document.getElementById('trendsContent').innerHTML = `
                <div class="text-center py-8 text-slate-500">
                    <p>Unable to fetch market insights: ${error.message}</p>
                    <button onclick="retryMarketTrends()" class="btn-secondary mt-2">Retry</button>
                </div>
            `;
        }
        
        throw error;
        
    } finally {
        // ALWAYS hide loading state regardless of success/failure
        if (currentWorkflow === 'presales') {
            document.getElementById('trendsLoading').classList.add('hidden');
        }
        
        // Clean up the running state if still marked as running
        if (backgroundProcesses.marketInsights.isRunning) {
            backgroundProcesses.marketInsights.isRunning = false;
        }
    }
}

// Enhanced debug function to check what's happening
function debugBackgroundProcesses() {
    console.log('=== BACKGROUND PROCESSES DEBUG ===');
    console.log('Market Insights:', {
        isRunning: backgroundProcesses.marketInsights.isRunning,
        completed: backgroundProcesses.marketInsights.completed,
        hasStoredData: !!storedMarketInsights
    });
    console.log('Company Intelligence:', {
        isRunning: backgroundProcesses.companyIntelligence.isRunning,
        completed: backgroundProcesses.companyIntelligence.completed,
        hasStoredData: !!storedCompanyInsights
    });
    console.log('Current Workflow:', currentWorkflow);
    console.log('Has Market Insights Flag:', hasMarketInsights);
    console.log('Has Company Insights Flag:', hasCompanyInsights);
    
    if (storedCompanyInsights) {
        console.log('Stored Company Insights Company:', storedCompanyInsights.company);
        console.log('Stored Company Insights Executive Summary:', storedCompanyInsights.executive_summary);
    }
    
    if (storedMarketInsights) {
        console.log('Stored Market Insights Executive Summary:', storedMarketInsights.executive_summary);
    }
}

function retryMarketTrends() {
    backgroundProcesses.marketInsights.completed = false;
    backgroundProcesses.marketInsights.isRunning = false;
    refreshMarketTrends();
}

function retryCompanyIntelligence() {
    backgroundProcesses.companyIntelligence.completed = false;
    backgroundProcesses.companyIntelligence.isRunning = false;
    fetchCompanyIntelligence();
}
function displayCompanyIntelligence(intelligence) {
    const content = document.getElementById('companyContent');
    const insights = intelligence.key_insights || intelligence.insights || intelligence.summary;
    
    console.log('displayCompanyIntelligence called with:', intelligence);
    console.log('insights extracted:', insights);
    
    if (insights) {
        // Parse the insights into four categories for the INSIGHTS SECTION
        const categorizedInsights = parseCompanyInsightsIntoCategories(insights);
        console.log('categorizedInsights:', categorizedInsights);
        
        // Display the categorized insights in the insights section
        content.innerHTML = `
            <div class="grid gap-4">
                <!-- Sales Conversation Starters -->
                <div class="bg-white p-4 rounded-lg border border-purple-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-purple-900">Sales Conversation Starters</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.conversationStarters}
                    </div>
                </div>

                <!-- Market Position and Strategic Leadership -->
                <div class="bg-white p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-blue-900">Market Position & Strategic Leadership</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.marketPosition}
                    </div>
                </div>

                <!-- Business Opportunities and Growth Areas -->
                <div class="bg-white p-4 rounded-lg border border-green-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-green-900">Business Opportunities & Growth Areas</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.businessOpportunities}
                    </div>
                </div>

                <!-- Areas of Focus and Potential Challenges -->
                <div class="bg-white p-4 rounded-lg border border-orange-200">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h4 class="font-semibold text-orange-900">Areas of Focus & Potential Challenges</h4>
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${categorizedInsights.focusAreas}
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-xs text-slate-500 text-center">
                ${intelligence.company}  ${intelligence.total_articles || 0} articles  ${intelligence.analysis_period || 'Recent'}  
                <a href="javascript:void(0)" onclick="viewCompanyIntelligenceDetails('${intelligence.company}')" class="text-blue-600 hover:text-blue-800 transition-colors ml-1">
                    View Details 
                </a>
            </div>
        `;
        
        // Store company insights with PROPERLY FORMATTED executive summary for strategic summary
        storedCompanyInsights = {
            ...intelligence,
            executive_summary: intelligence.executive_summary || {
                bullet_points: [
                    "Recent strategic developments for " + intelligence.company,
                    "Business opportunities identified in market analysis", 
                    "Competitive positioning shows growth potential"
                ]
            }
        };
        hasCompanyInsights = true;
        console.log('Company insights stored with executive summary for strategic summary:', intelligence.executive_summary);
        checkAndGenerateSummary();
    } else {
        console.log('No insights found');
        content.innerHTML = `
            <div class="text-center py-8 text-slate-500">
                <p>No strategic insights available for ${intelligence.company || 'this company'}.</p>
            </div>
        `;
    }
}
// Placeholder functions for the "View Details" links
function viewMarketTrendsDetails() {
    console.log(' View Market Trends Details clicked');
    
    // For now, show an alert - you can replace this with your detailed page navigation
    const industry = document.getElementById('presalesIndustry').value || 'Technology';
    
    alert(`Market Trends Details for ${industry}\n\nThis will navigate to the detailed market trends page when integrated.`);
    
    // TODO: Replace with actual navigation to detailed market trends page
    // Example: window.open(`/market-trends-detail?industry=${encodeURIComponent(industry)}`, '_blank');
    // Or: navigateToMarketTrendsDetail(industry);
}

function viewCompanyIntelligenceDetails(companyName) {
    console.log(' View Company Intelligence Details clicked for:', companyName);
    
    // For now, show an alert - you can replace this with your detailed page navigation
    alert(`Company Intelligence Details for ${companyName}\n\nThis will navigate to the detailed company intelligence page when integrated.`);
    
    // TODO: Replace with actual navigation to detailed company intelligence page
    // Example: window.open(`/company-intel-detail?company=${encodeURIComponent(companyName)}`, '_blank');
    // Or: navigateToCompanyIntelDetail(companyName);
}

// Updated updateStrategicSummaryDisplay function
function updateStrategicSummaryDisplay(useCasesFromCaseStudies, companySummary, marketSummary) {
    console.log(' updateStrategicSummaryDisplay called with:');
    console.log('- Use cases:', useCasesFromCaseStudies);
    console.log('- Company summary:', companySummary);
    console.log('- Market summary:', marketSummary);
    
    // 1. Top Use Cases - show each use case from each case study
    const useCasesEl = document.getElementById('topUseCases');
    if (useCasesFromCaseStudies && useCasesFromCaseStudies.length > 0) {
        useCasesEl.innerHTML = useCasesFromCaseStudies.map((useCase, index) => `
            <div class="flex items-start text-sm mb-2">
                <span class="bg-blue-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2 mt-0.5 flex-shrink-0">${index + 1}</span>
                <span class="text-slate-700">${useCase}</span>
            </div>
        `).join('');
    } else {
        useCasesEl.innerHTML = '<div class="text-slate-500 italic">No use cases found in case studies</div>';
    }

    // 2. Company Trends - HANDLE BOTH FORMATS
    const companyTrendsEl = document.getElementById('companyTrends');
    if (companySummary && companySummary.bullet_points && companySummary.bullet_points.length > 0) {
        const companyContent = companySummary.bullet_points.map((point, index) => `
            <div class="flex items-start text-sm mb-2">
                <span class="bg-green-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2 mt-0.5 flex-shrink-0">${index + 1}</span>
                <span class="text-slate-700">${formatBoldText(point)}</span>
            </div>
        `).join('');
        
        companyTrendsEl.innerHTML = companyContent;
    } else {
        companyTrendsEl.innerHTML = '<div class="text-slate-500 italic">Company insights loading...</div>';
    }

    // 3. Industry Trends - HANDLE BOTH FORMATS  
    const industryTrendsEl = document.getElementById('industryTrends');
    if (marketSummary && marketSummary.bullet_points && marketSummary.bullet_points.length > 0) {
        const marketContent = marketSummary.bullet_points.map((point, index) => `
            <div class="flex items-start text-sm mb-2">
                <span class="bg-purple-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2 mt-0.5 flex-shrink-0">${index + 1}</span>
                <span class="text-slate-700">${formatBoldText(point)}</span>
            </div>
        `).join('');
        
        industryTrendsEl.innerHTML = marketContent;
    } else {
        industryTrendsEl.innerHTML = '<div class="text-slate-500 italic">Market insights loading...</div>';
    }

    // Update stats
    const statsEl = document.getElementById('summaryStats');
    const industry = document.getElementById('presalesIndustry').value;
    const companyName = document.getElementById('presalesCompany').value;
    
    const totalUseCases = useCasesFromCaseStudies ? useCasesFromCaseStudies.length : 0;
    const companyPointsCount = companySummary?.bullet_points?.length || 0;
    const marketPointsCount = marketSummary?.bullet_points?.length || 0;
    
    const companyStatus = companyPointsCount > 0 ? ` ${companyPointsCount} company strategies` : ' Company trends loading...';
    const marketStatus = marketPointsCount > 0 ? ` ${marketPointsCount} market trends` : ' Market insights loading...';
    
    statsEl.innerHTML = `
        <span><strong>Strategic Summary:</strong> ${globalCaseStudies.length} case studies analyzed${industry ? ` in ${industry}` : ''}${companyName ? ` for ${companyName}` : ''}  ${totalUseCases} use cases identified ${companyStatus} ${marketStatus}</span>
    `;
}
function parseCompanyInsightsIntoCategories(insightsText) {
    console.log('parseCompanyInsightsIntoCategories called with:', insightsText);
    
    if (!insightsText) {
        console.log('No insights text provided');
        return {
            conversationStarters: 'No conversation starters available.',
            marketPosition: 'No market position data available.',
            businessOpportunities: 'No business opportunities identified.',
            focusAreas: 'No focus areas identified.'
        };
    }

    // Since your prompt generates structured output, parse the sections
    const sections = {
        conversationStarters: [],
        marketPosition: [],
        businessOpportunities: [],
        focusAreas: []
    };

    try {
        // Look for the structured sections in the response
        const conversationStartersMatch = insightsText.match(/SALES CONVERSATION STARTERS.*?\n((?:[-]\s*.+\n?){1,3})/is);
        const marketPositionMatch = insightsText.match(/MARKET POSITION AND STRATEGIC LEADERSHIP.*?\n((?:[-]\s*.+\n?){1,3})/is);
        const businessOpportunitiesMatch = insightsText.match(/BUSINESS OPPORTUNITIES AND GROWTH AREAS.*?\n((?:[-]\s*.+\n?){1,3})/is);
        const focusAreasMatch = insightsText.match(/AREAS OF FOCUS AND POTENTIAL CHALLENGES.*?\n((?:[-]\s*.+\n?){1,3})/is);

        console.log('Regex matches:');
        console.log('conversationStartersMatch:', conversationStartersMatch);
        console.log('marketPositionMatch:', marketPositionMatch);
        console.log('businessOpportunitiesMatch:', businessOpportunitiesMatch);
        console.log('focusAreasMatch:', focusAreasMatch);

        // Parse conversation starters
        if (conversationStartersMatch) {
            const conversationStarters = conversationStartersMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3);
            sections.conversationStarters = conversationStarters;
        }

        // Parse market position
        if (marketPositionMatch) {
            const marketPosition = marketPositionMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3);
            sections.marketPosition = marketPosition;
        }

        // Parse business opportunities
        if (businessOpportunitiesMatch) {
            const businessOpportunities = businessOpportunitiesMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3);
            sections.businessOpportunities = businessOpportunities;
        }

        // Parse focus areas
        if (focusAreasMatch) {
            const focusAreas = focusAreasMatch[1].split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .slice(0, 3);
            sections.focusAreas = focusAreas;
        }

        console.log('Parsed sections:', sections);

        // If structured parsing failed, try to extract bullet points from the entire text
        if (sections.conversationStarters.length === 0 && sections.marketPosition.length === 0 && sections.businessOpportunities.length === 0 && sections.focusAreas.length === 0) {
            console.log('Structured parsing failed, using fallback');
            const allBullets = insightsText.split('\n')
                .filter(line => line.trim() && (line.includes('-') || line.includes('')))
                .map(line => line.replace(/^[-]\s*/, '').trim())
                .filter(line => line.length > 0);

            console.log('All bullets found:', allBullets);

            // Distribute bullets across sections (max 3 each)
            const quarter = Math.ceil(allBullets.length / 4);
            sections.conversationStarters = allBullets.slice(0, Math.min(3, quarter));
            sections.marketPosition = allBullets.slice(quarter, Math.min(allBullets.length, quarter + 3));
            sections.businessOpportunities = allBullets.slice(quarter * 2, Math.min(allBullets.length, quarter * 2 + 3));
            sections.focusAreas = allBullets.slice(quarter * 3, Math.min(allBullets.length, quarter * 3 + 3));
        }

    } catch (error) {
        console.log('Error parsing structured company insights:', error);
        return {
            conversationStarters: 'Recent company updates available for discussion',
            marketPosition: 'Company position analysis in progress',
            businessOpportunities: 'Growth opportunities under evaluation',
            focusAreas: 'Strategic focus areas being assessed'
        };
    }

    // Format the results with proper HTML
    const result = {
        conversationStarters: sections.conversationStarters.length > 0 ? 
            sections.conversationStarters.map(point => `<div class="flex items-start mb-2">
                <span class="text-purple-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Recent updates available for conversation</div>',
            
        marketPosition: sections.marketPosition.length > 0 ? 
            sections.marketPosition.map(point => `<div class="flex items-start mb-2">
                <span class="text-blue-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Market position data not available</div>',
        
        businessOpportunities: sections.businessOpportunities.length > 0 ? 
            sections.businessOpportunities.map(point => `<div class="flex items-start mb-2">
                <span class="text-green-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Business opportunities under analysis</div>',
        
        focusAreas: sections.focusAreas.length > 0 ? 
            sections.focusAreas.map(point => `<div class="flex items-start mb-2">
                <span class="text-orange-600 mr-2"></span>
                <span>${formatBoldText(point)}</span>
            </div>`).join('') : 
            '<div class="text-slate-500 italic">Focus areas being evaluated</div>'
    };

    console.log('Final result:', result);
    return result;
}
async function generatePitch() {
    // Build search query with fallbacks for missing elements
    const searchQuery = {
        industry: document.getElementById('postsalesIndustry')?.value || '',
        region: document.getElementById('postsalesRegion')?.value || '',
        useCase: document.getElementById('postsalesUseCase')?.value || '',
        product: document.getElementById('postsalesProduct')?.value || '',
        prompt: document.getElementById('postsalesPrompt')?.value || ''
    };

    // Build pitch config with fallbacks
    const pitchConfig = {
        pitch_type: document.getElementById('pitchType')?.value || 'email',
        target_company: document.getElementById('targetCompany')?.value || '',
        custom_context: document.getElementById('additionalContext')?.value || '',
        bookmarked_case_studies: bookmarkedCaseStudies || [],
        bookmarked_use_cases: extractUseCasesFromBookmarks() || []
    };

    console.log('Search Query:', searchQuery);
    console.log('Pitch Config:', pitchConfig);

    try {
        const btn = document.getElementById('generateBtn');
        const btnText = document.getElementById('generateBtnText');
        btn.disabled = true;
        btnText.innerHTML = '<span class="loading-spinner mr-2"></span>Generating...';

        // First find cases (now with bookmark context)
        const casesResponse = await fetch('/find_similar_cases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...searchQuery,
                bookmarked_case_studies: pitchConfig.bookmarked_case_studies,
                bookmarked_use_cases: pitchConfig.bookmarked_use_cases
            })
        });

        if (!casesResponse.ok) {
            const errorText = await casesResponse.text();
            throw new Error(`Failed to find cases: ${errorText}`);
        }
        
        const casesData = await casesResponse.json();
        
        if (casesData.error) {
            throw new Error(casesData.error);
        }
        
        if (!casesData.case_studies?.length) {
            alert('No similar case studies found. Please try different parameters or bookmark some case studies first.');
            return;
        }

        // Then generate pitch with enhanced context
        const pitchRequest = {
            case_study_results: casesData.case_studies,
            pitch_type: pitchConfig.pitch_type,
            target_info: {
                company: pitchConfig.target_company,
                industry: searchQuery.industry,
                region: searchQuery.region
            },
            custom_context: pitchConfig.custom_context,
            bookmarked_case_studies: pitchConfig.bookmarked_case_studies,
            bookmarked_use_cases: pitchConfig.bookmarked_use_cases
        };

        console.log('Pitch Request:', pitchRequest);

        const pitchResponse = await fetch('/generate_pitch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pitchRequest)
        });

        if (!pitchResponse.ok) {
            const errorText = await pitchResponse.text();
            throw new Error(`Failed to generate pitch: ${errorText}`);
        }
        
        const pitchData = await pitchResponse.json();
        
        if (pitchData.error) {
            throw new Error(pitchData.error);
        }

        displayPitch(pitchData.pitch);
        displayPostsalesCaseStudies(casesData.case_studies);
        
        // NEW: Ensure pitch is saved to current deal
        setTimeout(() => {
            if (currentDealId) {
                saveCurrentDealData();
                console.log(' Generated pitch saved to deal');
            }
        }, 100);
        
    } catch (error) {
        console.error('Error generating pitch:', error);
        alert(`Error generating pitch: ${error.message}`);
    } finally {
        const btn = document.getElementById('generateBtn');
        const btnText = document.getElementById('generateBtnText');
        btn.disabled = false;
        btnText.textContent = 'Generate Pitch';
    }
}

        function displayPitch(pitchContent) {
    originalPitchContent = pitchContent;
    
    const formattedPitch = pitchContent
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mb-3">$1</h2>');
    
    const pitchContentEl = document.getElementById('pitchContent');
    pitchContentEl.innerHTML = formattedPitch;
    
    document.getElementById('pitchSection').classList.remove('hidden');
    document.getElementById('pitchSection').scrollIntoView({ behavior: 'smooth' });
    
    // NEW: Save the pitch to current deal immediately
    if (currentDealId) {
        saveCurrentDealData();
        console.log(' Pitch saved to deal');
    }
}

        function displayPostsalesCaseStudies(caseStudies) {
            const section = document.getElementById('postsalesCaseStudiesSection');
            const grid = document.getElementById('postsalesCaseStudiesGrid');
            const count = document.getElementById('postsalesCaseStudiesCount');
            
            count.textContent = `${caseStudies.length} result${caseStudies.length !== 1 ? 's' : ''} found`;
            
            grid.innerHTML = '';
            
            caseStudies.forEach(caseStudy => {
                const isBookmarked = bookmarkedCaseStudies.some(b => String(b.id) === String(caseStudy.id));
                
                const card = document.createElement('div');
                card.className = 'section-card relative';
                card.innerHTML = `
                    <button onclick="toggleBookmark('${caseStudy.id}')" class="bookmark-btn ${isBookmarked ? 'bookmarked' : ''}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </button>
                    
                    <h4 class="text-lg font-semibold text-slate-900 mb-3">${caseStudy.company || 'Unknown Company'}</h4>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${caseStudy.industry ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${caseStudy.industry}</span>` : ''}
                        ${caseStudy.region ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">${caseStudy.region}</span>` : ''}
                    </div>

                    ${caseStudy.use_case ? `
                        <div class="mb-3">
                            <p class="text-sm font-medium text-slate-700 mb-1">Use Cases</p>
                            <p class="text-sm text-slate-600">${caseStudy.use_case}</p>
                        </div>
                    ` : ''}

                    ${caseStudy.key_results ? `
                        <div class="mb-3">
                            <p class="text-sm font-medium text-slate-700 mb-1">Key Results</p>
                            <ul class="text-sm text-slate-600 space-y-1">
                                ${caseStudy.key_results.split(';').slice(0, 2).map(result => 
                                    result.trim() ? `<li class="flex items-start"><span class="text-green-600 mr-2"></span><span>${result.trim()}</span></li>` : ''
                                ).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                grid.appendChild(card);
            });
            
            section.classList.remove('hidden');
        }

        // Email functionality
        function sendPitchByEmail() {
            const targetCompany = document.getElementById('targetCompany').value || 'Prospect';
            const pitchType = document.getElementById('pitchType').value;
            
            const subject = `${pitchType.charAt(0).toUpperCase() + pitchType.slice(1)} - ${targetCompany}`;
            
            const emailBody = originalPitchContent
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/^# (.*$)/gim, '$1\n' + '='.repeat(50))
                .replace(/^## (.*$)/gim, '\n$1\n' + '-'.repeat(30))
                .trim();
            
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            try {
                window.location.href = mailtoUrl;
            } catch (error) {
                showEmailModal(subject, emailBody);
            }
        }

        function showEmailModal(subject, body) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden';
            modal.innerHTML = `
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Email Pitch</h3>
                        <button onclick="closeEmailModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subject:</label>
                        <input type="text" value="${subject}" class="w-full p-2 border border-gray-300 rounded-md" readonly>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Body:</label>
                        <textarea rows="15" class="w-full p-3 border border-gray-300 rounded-md font-mono text-sm" readonly>${body}</textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyEmailContent('${subject}', \`${body.replace(/`/g, '\\`')}\`)" class="btn-primary">
                            Copy Email Content
                        </button>
                        <button onclick="closeEmailModal()" class="btn-secondary">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            window.currentEmailModal = overlay;
            
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeEmailModal();
                }
            });
        }

        function closeEmailModal() {
            if (window.currentEmailModal) {
                document.body.removeChild(window.currentEmailModal);
                window.currentEmailModal = null;
            }
        }

        function copyEmailContent(subject, body) {
            const emailText = `Subject: ${subject}\n\n${body}`;
            navigator.clipboard.writeText(emailText).then(() => {
                alert('Email content copied to clipboard!');
                closeEmailModal();
            }).catch(() => {
                alert('Failed to copy email content');
            });
        }

        // Sticky Notes functionality
let stickyNotes = JSON.parse(localStorage.getItem('stickyNotes')) || [];
let noteIdCounter = parseInt(localStorage.getItem('noteIdCounter')) || 1;

function toggleStickyNotes() {
    const sidebar = document.getElementById('stickyNotesSidebar');
    const overlay = document.getElementById('stickyNotesOverlay');
    
    const isOpen = sidebar.classList.contains('open');
    
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        displayStickyNotes();
    }
}

function updateStickyNote(noteId, content) {
    const noteIndex = stickyNotes.findIndex(note => note.id === noteId);
    if (noteIndex > -1) {
        stickyNotes[noteIndex].content = content;
        stickyNotes[noteIndex].timestamp = new Date().toISOString();
        localStorage.setItem('stickyNotes', JSON.stringify(stickyNotes));
        
        // Save to current deal
        if (currentDealId) {
            saveCurrentDealData();
        }
    }
}

function deleteStickyNote(noteId) {
    stickyNotes = stickyNotes.filter(note => note.id !== noteId);
    localStorage.setItem('stickyNotes', JSON.stringify(stickyNotes));
    displayStickyNotes();
    
    // Save to current deal
    if (currentDealId) {
        saveCurrentDealData();
    }
}

function addStickyNote() {
    const newNote = {
        id: noteIdCounter++,
        content: '',
        timestamp: new Date().toISOString()
    };
    
    stickyNotes.unshift(newNote);
    localStorage.setItem('stickyNotes', JSON.stringify(stickyNotes));
    localStorage.setItem('noteIdCounter', noteIdCounter.toString());
    
    displayStickyNotes();
    
    // Save to current deal
    if (currentDealId) {
        saveCurrentDealData();
    }
    
    // Focus on the new note
    setTimeout(() => {
        const newNoteTextarea = document.querySelector(`#note-${newNote.id} textarea`);
        if (newNoteTextarea) {
            newNoteTextarea.focus();
        }
    }, 100);
}

function displayStickyNotes() {
    const list = document.getElementById('stickyNotesList');
    
    if (stickyNotes.length === 0) {
        list.innerHTML = `
            <div class="text-center py-12 text-slate-500">
                <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v9a2 2 0 01-2 2h-3l-4 4z"></path>
                </svg>
                <p>No notes yet</p>
                <p class="text-sm">Click "Add Note" to create your first sticky note</p>
            </div>
        `;
        return;
    }
    
    list.innerHTML = '';
    
    stickyNotes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'sticky-note';
        noteElement.id = `note-${note.id}`;
        noteElement.innerHTML = `
            <div class="note-actions">
                <button class="delete-note" onclick="deleteStickyNote(${note.id})" title="Delete note"></button>
            </div>
            <textarea 
                placeholder="Write your note here..."
                rows="4"
                oninput="updateStickyNote(${note.id}, this.value)"
            >${note.content}</textarea>
            <div class="text-xs text-slate-500 mt-2">
                ${new Date(note.timestamp).toLocaleDateString()} ${new Date(note.timestamp).toLocaleTimeString()}
            </div>
        `;
        list.appendChild(noteElement);
    });
}

function clearAllNotes() {
    if (stickyNotes.length === 0) {
        alert('No notes to clear');
        return;
    }
    
    if (confirm(`Clear all ${stickyNotes.length} notes?`)) {
        stickyNotes = [];
        localStorage.setItem('stickyNotes', JSON.stringify(stickyNotes));
        displayStickyNotes();
    }
}

function updateNavigationPanel() {
    const navPanel = document.getElementById('navMiniPanel');
    
    if (currentWorkflow === 'presales') {
        navPanel.innerHTML = `
            <div class="nav-mini-button" onclick="scrollToSection('caseStudiesSection')" title="Case Studies">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
            </div>
            <div class="nav-mini-button" onclick="scrollToSection('marketInsightsSection')" title="Market Insights">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <div class="nav-mini-button" onclick="makePitchFromExplore()" title="Make Pitch">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
        `;
    } else if (currentWorkflow === 'postsales') {
        navPanel.innerHTML = `
            <div class="nav-mini-button" onclick="scrollToSection('pitchSection')" title="Generated Pitch">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <div class="nav-mini-button" onclick="scrollToSection('postsalesCaseStudiesSection')" title="Similar Cases">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
            </div>
        `;
    }
}
function setupAutoSave() {
    // Save state every 30 seconds if there's an active deal
    setInterval(() => {
        if (currentDealId) {
            saveCurrentDealData();
        }
    }, 30000);
    
    // Save on major actions
    const originalExploreCaseStudies = exploreCaseStudies;
    window.exploreCaseStudies = async function() {
        await originalExploreCaseStudies();
        setTimeout(() => saveCurrentDealData(), 500);
    };
    
    const originalGeneratePitch = generatePitch;
    window.generatePitch = async function() {
        await originalGeneratePitch();
        setTimeout(() => saveCurrentDealData(), 500);
    };
}
function updateNavigationCircles() {
    updateNavigationPanel();
}
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section && !section.classList.contains('hidden')) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Bookmark functionality
    function toggleBookmark(caseStudyId) {
    const caseStudy = globalCaseStudies.find(cs => String(cs.id) === String(caseStudyId));
    if (!caseStudy) return;
    
    const existingIndex = bookmarkedCaseStudies.findIndex(b => String(b.id) === String(caseStudyId));
    
    // Determine new bookmark state
    let isNowBookmarked = false;
    if (existingIndex > -1) {
        bookmarkedCaseStudies.splice(existingIndex, 1);
        isNowBookmarked = false;
    } else {
        bookmarkedCaseStudies.push(caseStudy);
        isNowBookmarked = true;
    }
    
    // Immediately update the button styling
    const bookmarkButtons = document.querySelectorAll(`[onclick="toggleBookmark('${caseStudyId}')"]`);
    bookmarkButtons.forEach(button => {
        if (isNowBookmarked) {
            button.classList.add('bookmarked');
        } else {
            button.classList.remove('bookmarked');
        }
    });
    
    localStorage.setItem('bookmarkedCaseStudies', JSON.stringify(bookmarkedCaseStudies));
    updateBookmarkCount();
    updateReferenceDropdown();
    updateBookmarkSidebar();
    updateUseCaseDisplay();
    
    // NEW: Save to current deal
    if (currentDealId) {
        saveCurrentDealData();
    }
    
    // Refresh displays
    if (currentWorkflow === 'presales' && globalCaseStudies.length > 0) {
        displayCaseStudiesGrid(globalCaseStudies);
    }
}

        function updateBookmarkCount() {
    const count = document.getElementById('bookmarkCount');
    const total = bookmarkedCaseStudies.length;
    
    if (count) {
        if (total > 0) {
            count.textContent = total;
            count.classList.remove('hidden');
        } else {
            count.classList.add('hidden');
        }
    }
}

        function updateReferenceDropdown() {
            const dropdown = document.getElementById('referenceCaseStudy');
            dropdown.innerHTML = '<option value="">Choose bookmarked case study</option>';
            
            bookmarkedCaseStudies.forEach(caseStudy => {
                const option = document.createElement('option');
                option.value = JSON.stringify(caseStudy);
                option.textContent = `${caseStudy.company} - ${caseStudy.industry || 'Unknown Industry'}`;
                dropdown.appendChild(option);
            });
        }

        function toggleBookmarkSidebar() {
            const sidebar = document.getElementById('bookmarkSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                updateBookmarkSidebar();
            }
        }

function updateBookmarkSidebar() {
    const list = document.getElementById('bookmarkList');
    
    if (bookmarkedCaseStudies.length === 0) {
        list.innerHTML = `
            <div class="text-center py-12 text-slate-500">
                <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
                </svg>
                <p>No bookmarks yet</p>
                <p class="text-sm">Bookmark case studies to save them for later</p>
            </div>
        `;
        return;
    }
    
    list.innerHTML = '';
    
    // Show use cases summary if there are bookmarks
    const useCases = extractUseCasesFromBookmarks();
    if (useCases.length > 0) {
        const summaryItem = document.createElement('div');
        summaryItem.className = 'bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4';
        summaryItem.innerHTML = `
            <h4 class="font-medium text-blue-900 mb-2">Active Use Cases for Pitch Generation</h4>
            <div class="flex flex-wrap gap-2">
                ${useCases.map(useCase => `
                    <span class="bookmark-indicator">${useCase}</span>
                `).join('')}
            </div>
            <p class="text-xs text-blue-700 mt-2">These use cases will be used as filters when generating pitches</p>
        `;
        list.appendChild(summaryItem);
    }
    
    bookmarkedCaseStudies.forEach(caseStudy => {
        const item = document.createElement('div');
        item.className = 'bg-slate-100 p-4 rounded-lg border border-slate-200';
        // NEW: Add a data attribute for easier identification
        item.setAttribute('data-bookmark-id', caseStudy.id);
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-medium text-slate-900 mb-1">${caseStudy.company || 'Unknown Company'}</h4>
                    <div class="flex flex-wrap gap-1 mb-2">
                        ${caseStudy.industry ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${caseStudy.industry}</span>` : ''}
                        ${caseStudy.region ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">${caseStudy.region}</span>` : ''}
                    </div>
                    ${caseStudy.use_case ? `<p class="text-sm text-slate-600">${caseStudy.use_case.length > 80 ? caseStudy.use_case.substring(0, 80) + '...' : caseStudy.use_case}</p>` : ''}
                </div>
                <button onclick="removeBookmark('${caseStudy.id}')" class="text-red-500 hover:text-red-700 ml-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
        list.appendChild(item);
    });
}

    function removeBookmark(caseStudyId) {
    const index = bookmarkedCaseStudies.findIndex(b => String(b.id) === String(caseStudyId));
    if (index > -1) {
        bookmarkedCaseStudies.splice(index, 1);
        
        // NEW: Immediately update ALL bookmark buttons for this case study ID
        const bookmarkButtons = document.querySelectorAll(`[onclick="toggleBookmark('${caseStudyId}')"]`);
        bookmarkButtons.forEach(button => {
            button.classList.remove('bookmarked');
        });
        
        // NEW: Immediately remove the bookmark item from the sidebar
        const bookmarkItem = document.querySelector(`[onclick="removeBookmark('${caseStudyId}')"]`);
        if (bookmarkItem) {
            // Find the parent container (the entire bookmark card)
            const bookmarkCard = bookmarkItem.closest('.bg-slate-100');
            if (bookmarkCard) {
                bookmarkCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                bookmarkCard.style.opacity = '0';
                bookmarkCard.style.transform = 'translateX(100%)';
                
                // Remove the element after animation
                setTimeout(() => {
                    if (bookmarkCard.parentNode) {
                        bookmarkCard.parentNode.removeChild(bookmarkCard);
                    }
                }, 300);
            }
        }
        
        localStorage.setItem('bookmarkedCaseStudies', JSON.stringify(bookmarkedCaseStudies));
        updateBookmarkCount();
        updateReferenceDropdown();
        updateUseCaseDisplay();
        
        // NEW: Check if sidebar is now empty and update accordingly
        setTimeout(() => {
            if (bookmarkedCaseStudies.length === 0) {
                updateBookmarkSidebar(); // This will show the "no bookmarks" message
            }
        }, 350);
    }
}

        function exportBookmarks() {
            if (bookmarkedCaseStudies.length === 0) {
                alert('No bookmarks to export');
                return;
            }
            
            const dataStr = JSON.stringify(bookmarkedCaseStudies, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `bookmarks_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearAllBookmarks() {
            if (bookmarkedCaseStudies.length === 0) {
                alert('No bookmarks to clear');
                return;
            }
            
            if (confirm(`Clear all ${bookmarkedCaseStudies.length} bookmarks?`)) {
                bookmarkedCaseStudies = [];
                localStorage.setItem('bookmarkedCaseStudies', JSON.stringify(bookmarkedCaseStudies));
                updateBookmarkCount();
                updateReferenceDropdown();
                updateBookmarkSidebar();
            }
        }

        // Pitch editing
        function editPitch() {
            const content = document.getElementById('pitchContent');
            const currentHTML = content.innerHTML;
            
            content.innerHTML = `
                <textarea class="w-full h-96 p-4 border border-slate-300 rounded-lg resize-vertical font-mono text-sm" id="pitchEditor">${originalPitchContent}</textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="savePitchEdit()" class="btn-primary">Save</button>
                    <button onclick="cancelPitchEdit('${currentHTML.replace(/'/g, "\\'")}'" class="btn-secondary">Cancel</button>
                </div>
            `;
        }

        function savePitchEdit() {
    const editor = document.getElementById('pitchEditor');
    originalPitchContent = editor.value;
    displayPitch(originalPitchContent);
    
    // Save to current deal
    if (currentDealId) {
        saveCurrentDealData();
        console.log(' Edited pitch saved to deal');
    }
}

        function cancelPitchEdit(originalHTML) {
            document.getElementById('pitchContent').innerHTML = originalHTML;
        }

        function copyPitch() {
            navigator.clipboard.writeText(originalPitchContent).then(() => {
                alert('Pitch copied to clipboard');
            }).catch(() => {
                alert('Failed to copy pitch');
            });
        }

        function downloadPitch() {
            const company = document.getElementById('targetCompany').value || 'Target_Company';
            const type = document.getElementById('pitchType').value;
            const filename = `${company}_${type}_pitch.txt`;
            
            const blob = new Blob([originalPitchContent], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Utility functions
        function formatInsights(text) {
            return text
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(.*)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '');
        }
// Update use case display with bookmarked use cases
function updateUseCaseDisplay() {
    const useCases = extractUseCasesFromBookmarks();
    const indicator = document.getElementById('activeUseCasesIndicator');
    const tagsContainer = document.getElementById('activeUseCasesTags');
    
    if (useCases.length > 0) {
        // Show the indicator
        indicator.classList.remove('hidden');
        
        // Create tags for each use case
        tagsContainer.innerHTML = useCases.map(useCase => `
            <span class="bookmark-indicator text-xs">${useCase}</span>
        `).join('');
        
        // Auto-select the first matching use case in the dropdown
        const useCaseSelect = document.getElementById('postsalesUseCase');
        const availableOptions = Array.from(useCaseSelect.options).map(opt => opt.value).filter(val => val);
        
        for (const useCase of useCases) {
            const matchingOption = availableOptions.find(option => 
                option.toLowerCase().includes(useCase.toLowerCase()) || 
                useCase.toLowerCase().includes(option.toLowerCase())
            );
            
            if (matchingOption) {
                useCaseSelect.value = matchingOption;
                break; // Use the first match
            }
        }
    } else {
        // Hide the indicator if no bookmarks
        indicator.classList.add('hidden');
        tagsContainer.innerHTML = '';
    }
}
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.target.matches('textarea')) {
                e.preventDefault();
                
                if (currentWorkflow === 'presales') {
                    if (document.activeElement === document.getElementById('companyFilter')) {
                        fetchCompanyIntelligence();
                    } else if (document.activeElement.matches('.input-field, input, select')) {
                        exploreCaseStudies();
                    } else {
                        exploreCaseStudies();
                    }
                } else if (currentWorkflow === 'postsales') {
                    generatePitch();
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
        const companyInput = document.getElementById('companyFilter');
if (companyInput) {
    companyInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            fetchCompanyIntelligence();
        }
    });
}

const industrySelect = document.getElementById('industryFilter');
if (industrySelect) {
    industrySelect.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            refreshMarketTrends();
        }
    });
}
        });
    </script>
    <!-- New Deal Modal -->
<div id="newDealModal" class="deal-modal">
    <div class="deal-modal-content">
        <h3>Create New Deal</h3>
        <form onsubmit="createNewDeal(event)">
            <label for="dealName">Deal Name *</label>
            <input type="text" id="dealName" required>
            
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName">
            
            <label for="dealDescription">Description</label>
            <textarea id="dealDescription" rows="3"></textarea>
            
            <div class="deal-modal-actions">
                <button type="button" onclick="closeModal('newDealModal')" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Create Deal</button>
            </div>
        </form>
    </div>
</div>

<!-- Manage Deals Modal -->
<div id="manageDealsModal" class="deal-modal">
    <div class="deal-modal-content">
        <h3>Manage Deals</h3>
        <div id="dealsList">
            <!-- Deals will be populated here -->
        </div>
        <div class="deal-modal-actions">
            <button onclick="closeModal('manageDealsModal')" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
</body>
</html>